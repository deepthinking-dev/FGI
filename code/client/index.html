
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="renderer" content="webkit"/>
    <title>FGI</title>
    <!-- Tell the browser to be responsive to screen width -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <!-- Bootstrap 3.3.5 -->
    <link href="./plugins/bootstrap/3.3.5/bootstrap.min.css" rel="stylesheet">
    <link href="./plugins/bootstrap-colorpicker/dist/css/bootstrap-colorpicker.min.css" rel="stylesheet">
    <link href="./plugins/topology/layout.css" rel="stylesheet">
    <link href="./lkr.css" rel="stylesheet">
    <link href="./LogicMath.css" rel="stylesheet">
    <link href="./toastr.css" rel="stylesheet">
    <link href="plugins/tree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet">
    <!-- <link href="css/lanrenzhijia.css" type="text/css" rel="stylesheet" /> -->
    <!-- 矢量图标库 -->
    <link href="http://at.alicdn.com/t/font_1113798_0532l8oa6jqp.css" rel="stylesheet"/>
    <link href="http://at.alicdn.com/t/font_1331132_5lvbai88wkb.css" rel="stylesheet"/>
    <style>
        .left-list{
            width: 65%;
            margin: auto;
        }
        .left-list-event{
            border: 1px dashed #4295ec;
            display: flex;
            justify-content: space-between;
        }
        .left-list-tilte{
            color: #ffffff;
            justify-content: center;
            align-items: center;
            background-image: url(./static/mum1.png);
            background-size: 100% 100%;
            background-repeat: no-repeat;
            margin: 10px 0;
            overflow: hidden;
            text-overflow:ellipsis;
            white-space: nowrap;
            width: 192px;
            line-height: 50px;
            text-align: center;
        }
        i{
            font-style:normal
        }
        .liactive{
            /* color: #4cb1ff!important; */
            opacity: 1 !important;
        }
        .divactive{
            color: aqua!important;
        }
        #edui1_elementpath,#edui1_wordcount,#edui1_scale{
            display: none;
        }
        #editor .edui-editor-imagescale{
            display: none !important;
        }
        .ztree li span{
            color: #45a1e9;
        }
        .aqua{
            color: aqua !important;
        }
        .red{
            color:red
        }
    </style>
    <script src="./plugins/jquery/3.3.1/jquery-3.3.1.min.js"></script>
    <script src="./plugins/bootstrap/3.3.5/bootstrap.min.js"></script>
    <script src="./topology/formula.js"></script>
    <script src="./toastr.js"></script>
    <script type="text/javascript" charset="utf-8" src="./ueditor/ueditor.config.js"></script>
    <script type="text/javascript" charset="utf-8" src="./ueditor/ueditor.all.min.js"> </script>
    <script type="text/javascript" charset="utf-8" src="./ueditor/kityformula-plugin/addKityFormulaDialog.js"></script>
    <script type="text/javascript" charset="utf-8" src="./ueditor/kityformula-plugin/getKfContent.js"></script>
    <script type="text/javascript" charset="utf-8" src="./ueditor/kityformula-plugin/defaultFilterFix.js"></script>
    <script type="text/javascript" charset="utf-8" src="./plugins/tree/js/tree.all.min.js"></script>
        <!--建议手动加在语言，避免在ie下有时因为加载语言失败导致编辑器加载失败-->
        <!--这里加载的语言文件会覆盖你在配置项目里添加的语言类型，比如你在配置项目里配置的是英文，这里加载的中文，那最后就是中文-->
    <script type="text/javascript" charset="utf-8" src="./ueditor/lang/zh-cn/zh-cn.js"></script>
    <script src="./plugins/html2canvas.js"></script>
    <!-- <script src="./plugins/html2.js"></script> -->
    <script type="text/javascript">

        //实例化编辑器
        //建议使用工厂方法getEditor创建和引用编辑器实例，如果在某个闭包下引用该编辑器，直接调用UE.getEditor('editor')就能拿到相关的实例
        var ue = UE.getEditor('editor',{
        toolbars: [[
            
             '|', 'kityformula',
        ]]
    });
    var data = null
        function isFocus(e){
            alert(UE.getEditor('editor').isFocus());
            UE.dom.domUtils.preventDefault(e)
        }
        function setblur(e){
            UE.getEditor('editor').blur();
            UE.dom.domUtils.preventDefault(e)
        }
        function insertHtml() {
            var value = prompt('插入html代码', '');
            UE.getEditor('editor').execCommand('insertHtml', value)
        }
        function createEditor() {
            enableBtn();
            UE.getEditor('editor');
        }
        function getAllHtml() {
            alert(UE.getEditor('editor').getAllHtml())
        }
        function getContent() {
            var arr = [];
            arr.push("使用editor.getContent()方法可以获得编辑器的内容");
            arr.push("内容为：");
            arr.push(UE.getEditor('editor').getContent());
            data = UE.getEditor('editor').getContent()
            alert(arr.join("\n"));
        }
        function getPlainTxt() {
            var arr = [];
            arr.push("使用editor.getPlainTxt()方法可以获得编辑器的带格式的纯文本内容");
            arr.push("内容为：");
            arr.push(UE.getEditor('editor').getPlainTxt());
            alert(arr.join('\n'))
        }
        function setContent(isAppendTo) {
            // var arr = [];
            // arr.push("使用editor.setContent('欢迎使用ueditor')方法可以设置编辑器的内容");
            // UE.getEditor('editor').setContent(data);
            // alert(arr.join("\n"));
    
    
            let img = sessionStorage.getItem('src')
            let latex = sessionStorage.getItem('latex')
            // editor.execCommand('inserthtml', '<img class="kfformula" src="'+img +'" data-latex="' + latex + '" />');
            UE.getEditor('editor').setContent('<img class="kfformula" src="'+img +'" data-latex="' + latex + '" />');
        }
        function setDisabled() {
            UE.getEditor('editor').setDisabled('fullscreen');
            disableBtn("enable");
        }
    
        function setEnabled() {
            UE.getEditor('editor').setEnabled();
            enableBtn();
        }
    
        function getText() {
            //当你点击按钮时编辑区域已经失去了焦点，如果直接用getText将不会得到内容，所以要在选回来，然后取得内容
            var range = UE.getEditor('editor').selection.getRange();
            range.select();
            var txt = UE.getEditor('editor').selection.getText();
            alert(txt)
        }
    
        function getContentTxt() {
            var arr = [];
            arr.push("使用editor.getContentTxt()方法可以获得编辑器的纯文本内容");
            arr.push("编辑器的纯文本内容为：");
            arr.push(UE.getEditor('editor').hasContents());
            alert(arr.join("\n"));
        }
        function hasContent() {
            var arr = [];
            arr.push("使用editor.hasContents()方法判断编辑器里是否有内容");
            arr.push("判断结果为：");
            arr.push(UE.getEditor('editor').hasContents());
            alert(arr.join("\n"));
        }
        function setFocus() {
            UE.getEditor('editor').focus();
        }
        function deleteEditor() {
            disableBtn();
            UE.getEditor('editor').destroy();
        }
        function disableBtn(str) {
            var div = document.getElementById('btns');
            var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
            for (var i = 0, btn; btn = btns[i++];) {
                if (btn.id == str) {
                    UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
                } else {
                    btn.setAttribute("disabled", "true");
                }
            }
        }
        function enableBtn() {
            var div = document.getElementById('btns');
            var btns = UE.dom.domUtils.getElementsByTagName(div, "button");
            for (var i = 0, btn; btn = btns[i++];) {
                UE.dom.domUtils.removeAttributes(btn, ["disabled"]);
            }
        }
    
        function getLocalData () {
            alert(UE.getEditor('editor').execCommand( "getlocaldata" ));
        }
    
        function clearLocalData () {
            UE.getEditor('editor').execCommand( "clearlocaldata" );
            alert("已清空草稿箱")
        }
    </script>
</head>
<body>
     <div id="showCsName" style="z-index: 999;color: #fff;"></div>
       <!-- 关系选择 -->
    <div id="ruleAct">
        <div class="head-hidden" style="width: 100%;height: 50px;overflow: hidden;z-index: 99;position: relative;"></div>
        <div class="ruleInfo">           
            <span class="ActTitle">算子详情</span>
            <div class="ActContont">
                <div style="margin: 5px 20px;display:flex;">
                    <label style="line-height: 20px;width: 70px;text-align: left">作者：</label>
                    <span class="ruleActionZZ">111</span>
                </div>
                <div style="margin: 5px 20px;display: flex;">
                    <label style="line-height: 20px;width: 70px;text-align: left">算法名称：</label>
                    <span class="ruleActionMC">222</span>
                </div>
                <div style="margin: 5px 20px;display: flex;">
                    <label style="line-height: 20px;width: 70px;text-align: left">算法描述：</label>
                    <span class="ruleActionMS">333</span>
                </div>
            </div>
        </div>
        <button class="ruleAddButton" type="button" onclick="ruleAddButtonS()">+</button> 
        <div class="ruleContentDiv">

        </div>

        <div class="footerAct">
            <button class="btn pointer" type="button" onclick="ActionSure(event)" style="margin-right: 10px;background: #409eff;color: #fff">确定</button>
            <button class="btn pointer" type="button" onclick="ActionClose()" style="margin-right: 10px;background: #f56c6c;color: #fff">取消</button>
        </div>

    </div>
<!--       动作-->
       <div id="actionDiv">
           <div style="text-align: center;margin-top: 20px">
               <span>动作对象</span>
               <select id="selectOutIn">
                   <option value="1">输入端参数</option>
                   <option value="2">输出端参数</option>
               </select>
               <button type="button" id="addActionButton" style="background: #409eff;color: #fff;height: 26px;width: 26px;border: none;margin-left: 10px">+</button>
           </div>
           <div style="margin: 20px 20px;height: 400px;overflow: auto;" id="actionInDiv"></div>
           <div style="margin: 20px 20px;height: 400px;overflow: auto;display: none" id="actionOutDiv"></div>
           <span style="margin-left: 20px;margin-top: 4px">逻辑关系</span>
           <select id="addLjSelect">
               <option>&</option>
               <option>|</option>
               <option>!</option>
           </select>
           <button class="addLjgxType" type="button"  style="background: #409eff;color: #fff;margin-left: 15px;height: 20px;border: none;width: 22px">+</button>
           <input type="text" id="actionMsgIn">
           <input type="text" id="actionMsgOut">
           <div style="position: absolute;bottom: 20px;right: 0">
               <button onclick="closeActionDiv()" class="btn pointer" type="button" style="margin-right: 40px;background: #f56c6c;color: #fff;float: right">取消</button>
               <button id="addAction" class="btn pointer" type="button" style="margin-right: 15px;background: #409eff;color: #fff;float: right">确定</button>
           </div>
       </div>

     <div id="actionDivLine">
         <div style="height: 35px">
             <span class="actionDivLineInName" style="position: absolute;left: 20%;top:5px">输入参数</span>
             <span class="actionDivLineOutName" style="position: absolute;left:65%;top:5px">输出参数</span>
            <span class="closeActionDivLine" style="color:#fff;float: right;cursor: pointer;font-size: 16px;margin-right: 25px;margin-top: 5px">X</span>
         </div>
         <div style="margin: 10px 5px;height: 400px;overflow: auto;width: 47%;float: left;margin-left: 25px;border-right: 1px solid #fff" id="actionDivLineIn"></div>
         <div style="margin: 10px 5px;height: 400px;overflow: auto;width: 47%;float: left" id="actionDivLineOut"></div>
         <input type="text" id="actionMsgInLine" disabled>
         <input type="text" id="actionMsgOutLine" disabled>
     </div>
       <!-- 动作弹窗选择参数-->
       <div id="actionSelectDiv">
           <div style="text-align: center;margin-top: 20px">
               <p>
                   <span>模型字段</span>
                   <select id="actionSelectParma"></select>
               </p>
               <p>
                   <span>来源值</span>
                   <select id="actionSelectName"></select>
               </p>
           </div>
           <div style="position: absolute;bottom: 20px;right: 0">
               <button onclick="closeactionSelectDiv()" class="btn pointer" type="button" style="margin-right: 35px;background: #f56c6c;color: #fff;float: right">取消</button>
               <button id="actionSelectButton" class="btn pointer" type="button" style="margin-right: 15px;background: #409eff;color: #fff;float: right">确定</button>
           </div>
       </div>
<!--       入口备注-->
       <div id="rkDiv">
           <div style="text-align: center;margin: 25px 0">
                <p style="color:#fff;">算法备注</p>
           </div>
           <textarea id="bzMsg"></textarea>
           <div style="position: absolute;bottom: 20px;right: 0">
               <button class="btn pointer" onclick="closeBz()" type="button" style="margin-right: 35px;background: #f56c6c;color: #fff;float: right">取消</button>
               <button class="btn pointer" onclick="saveBzMsg()"  type="button" style="margin-right: 15px;background: #409eff;color: #fff;float: right">确定</button>
           </div>
       </div>
    <!-- 保存规则 -->
    <div id="sureRule">
        <div class="title">
            <span>保存规则</span>
            <span onclick="RuleClose()" style="cursor: pointer;">X</span>
        </div>
        <div class="ruleContent"> 
            <li><span>规则名称<i style="color: red;font-size: 16px;display: inline-block">*</i> </span><input maxlength="200" id="ruleName" type="text" placeholder="请输入规则名称"></li>
            <li><div style="width: 120px;float: left;text-align: right;margin-top: 20px;margin-right: 10px;">规则描述 </div><textarea maxlength="500" id="ruleRemark" type="text" placeholder="请输入规则描述"></textarea></li>
            <li style="margin: 0"><span>分组名称<i style="color: red;font-size: 16px;display: inline-block">*</i> </span><input placeholder="请双击选择分组" id="gzGroupName" type="text" ondblclick="groupTreeDataShow(3)"></li>
            <li style="display:none;"><span>备注 </span><input id="ruleDes" type="text" placeholder="请输入规则备注"></li>
            <button onclick="ruleSure()">确定</button>
        </div>
    </div>
     <!-- fgi模型表 -->
    <div id="sourceName" class="lkr-frame" style="z-index: 999999; display: none;">
        <div class="lkr-frame-div" style="height: 520px;">
            <div class="lkr-source-tilte">
                链接数据源
                <span style="cursor: pointer;" onclick='sourceNameClose()'>x</span>
            </div>
            <div id="addSource" class="addSource">
                <select id='fgiName' class="lkr-select">
                    <option>卫星信号规格参数A表</option>
                </select>
                <table class="lkr-table" border="1">
                    <thead>
                        <tr>
                        <td>
                            <input type="checkbox" name="item" id="selectAll"/>
                        </td>
                        <td>
                            中文名称
                        </td>
                        <td>
                            英文名称
                        </td>
                        <td>
                            字段类型
                        </td>
                        <td>
                            备注
                        </td>
                        </tr>
                    </thead>
                    <tbody class="">
                    
                    </tbody>
                </table>
            </div>
            <div class="lkr-frame-foot">
                <div class="lkr-button" onclick='sourceNameConfirm()'>确定</div>
            </div>
        </div>
        
        
    </div>
    <!-- 新建/编辑算法 -->
    <div class="lkr-frame" id='AddAlgorithm'>
        <div class="lkr-frame-div" style="height: 350px;">
            <div class="lkr-frame-tilte">
                新建/编辑算法
                <span style="cursor: pointer;" onclick='AlgorithmClose()'>x</span>
            </div>
            <div class="lkr-frame-content">
<!--                <div style="margin: 15px 0;display: flex;align-items: center;">-->
<!--                    <label style="line-height: 10px;width: 100px;">作者：</label>-->
<!--                    <input id="szAuthor" type='text' class="lkr-input" style="flex:1;margin-left: 10px;"/>-->
<!--                </div>              -->
<!--                <div style="margin: 15px 0;display: flex;align-items: center;">-->
<!--                    <label style="line-height: 10px;width: 100px;">描述：</label>-->
<!--                    <textarea id="szDes"  type='text' class="lkr-input" style="flex:1;margin-left: 10px;"></textarea>-->
<!--                </div>-->
                <div style="margin: 15px 0;display: flex;align-items: center;">
                    <label style="line-height: 10px;width: 100px;">算法类型：</label>
                    <select id="sfType" class="lkr-select" style="flex: 1;margin-left: 10px;">
                        <option>算法公式</option>
                        <option>逻辑运算</option>
                    </select>                    
                </div>
            </div>
            <div class="lkr-frame-foot">
                <div class="lkr-button" onclick='AlgorithmConfirm()'>确定</div>
            </div>
        </div>
        
    </div>
    <!-- 数据模型 -->
    <div id="dataModulePage">
        <div class="title">
            <span>数据模型</span>
            <span onclick="ModuleClose()" style="cursor: pointer;float: right">X</span>
        </div>
        <div class="addButtonModlue" style="position: relative;top:70px;margin:0 15px">
            <button class="addModlue" onclick="addModule()">新增</button>
            <div style="height: 520px;overflow: auto">
                <ul id="modelWinTree" class="ztree" style="width: 250px;float: left;overflow:auto;"></ul>
                <table class="mxGruopTable" style="float: left;"></table>
            </div>
        </div>
    </div>
    <!-- 算法确认删除框 -->
    <div class="lkr-frame" id='lkrRule'>
        <div class="lkr-frame-div" style="height: 150px;">
            <div class="lkr-frame-content">
                <h3>
                    确认删除此规则?
                </h3>
                
            </div>
            <div class="lkr-frame-foot">
                <div class="lkr-button" onclick='ConfirmDelRule()' style="margin-right: 10px;">确定</div>
                <div class="lkr-button" onclick='ruleDelClose()'>取消</div>
            </div>
        </div>
    </div>
    <!-- 规则确认删除框 -->
    <div class="lkr-frame" id='ruleDeleteDiv'>
        <div class="lkr-frame-div" style="height: 150px;">
            <div class="lkr-frame-content">
                <h3>
                    确认删除此规则?
                </h3>

            </div>
            <div class="lkr-frame-foot">
                <div class="lkr-button" onclick='ConfirmDelRule()' style="margin-right: 10px;">确定</div>
                <div class="lkr-button" onclick='ruleDelClose()'>取消</div>
            </div>
        </div>
    </div>
       <!-- 模型确认删除框 -->
       <div class="lkr-frame" id='moduleGroupDelete'>
           <div class="lkr-frame-div" style="height: 150px;">
               <div class="lkr-frame-content">
                   <h3>
                       确认删除此分组?
                   </h3>

               </div>
               <div class="lkr-frame-foot">
                   <div class="lkr-button" id="moduleGroupDeleteYes" style="margin-right: 10px;">确定</div>
                   <div class="lkr-button" onclick='closeModuleGroupDelete()'>取消</div>
               </div>
           </div>
       </div>
    <!-- 上传导入文件框 -->
    <div id="fileupload">
        <div class="title">
            <span>导入规则</span>
            <span onclick="uploadClose()" style="cursor: pointer;">X</span>
        </div>
        <form class="uploadForm" name="uploadForm">
            <input class="inputfile" name="inputfile" type="file" multiple="multiple" 
            accept="application/json,text/plain,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,text/xml, application/xml"/>
        </form>
        <button class="btn btn-primary mr10 btn-sm pointer" type="button" onclick="uploadSure()">确定</button>
    </div>
    <!-- 数据项选择字段信息弹框 -->
    <div id="fields">
        <div class="title">
            <span>字段信息</span>
            <span onclick="fieldsClose()" style="cursor: pointer;">X</span>
        </div>
        <div class="fieldsContent">
            <table class="table">
                <thead>
                    <tr>
                        <th>字段名称</th>
                        <th>字段类型</th>
                        <th>字段描述</th>
                    </tr>
                </thead>
                <tbody class="fieldsList" style="height:320px">
                    
                </tbody>
            </table>                     
        </div>
        <div class="frame-foot">
            <div class="button" onclick='ConfirmFields()'>确定</div>
        </div>
    </div>
    <!-- 公式编辑 -->
    <div class="Frame" id="gsFrame">
        <div class="title">
            <span class="gsTitle">公式编辑</span>
            <span onclick="FrameClose()" style="cursor: pointer;color:#fff;float: right;">X</span>
        </div>
        <div class="form-group">
            <div id="authorShow">
                <input type="text" style="display: none" value="" id="gsStatus">
                <input type="text" style="display: none" value="" id="updateSzId">
                <div>
                    <span class="form-span">作者</span>
                    <input id="gsName" type="text" maxlength="20">
                </div>
                <div style="margin: 8px 0">
                    <span class="form-span">单位信息</span>
                    <input type="text" id="companyGs" maxlength="100">
                </div>
                <div>
                    <span class="form-span">描述</span>
                    <input id="gsDes" type="text" maxlength="500">
                </div>
            </div>
            <div>
                <span class="form-span">算法名称<span style="color: red;font-size: 16px;display: inline-block">*</span></span>
                <input id="AlgorithmnameY" type="text" maxlength="200">
            </div>
            <div>
                <span class="form-span">分组<span style="color: red;font-size: 16px;display: inline-block">*</span></span>
                <input type="text" id="groupGs" ondblclick="groupTreeDataShow(2,2)" placeholder="请双击选择分组">
            </div>
            <!-- <div class="AlgorithInput">
                <span class="form-span">公式编辑<span style="color: red;font-size: 16px;display: inline-block">*</span></span>
                <iframe id="mainContent" src="./kityformula-editor/index.html" width="850px" height="245px"></iframe>
            </div> -->
            <!-- <div>
                <script id="editor" type="text/plain" style="width:500px;height:200px;"></script>
            </div> -->
            <div>
                <span class="form-span">公式编辑<span style="color: red;font-size: 16px;display: inline-block">*</span></span>
                <!-- <h1>完整demo</h1> -->
                <script id="editor" type="text/plain" style="position: relative; display: inline-block;width: 500px; margin-left: 145px; margin-top: -40px;z-index: 999999;"></script>
            </div>
            <div id="btns">
                <div>
                    <!-- <button onclick="setContent()">回显</button> -->
                </div>
            </div>
            <!-- <div class="AlgorithInput">
                <span class="form-span">公式编辑<span style="color: red;font-size: 16px;display: inline-block">*</span></span>
                <input id="MathInput" onblur="Preview.Update()" type="text" >
            </div>      
            <div>
                <span class="form-span">公式预览</span>
                <div id="MathPreview"></div>
                <div id="MathBuffer" style="font-size: 20px;visibility:hidden; position:absolute; top:0; left: 0;margin: 0 auto;"></div>
            </div> -->

        </div>
        <div class="form-group MathJaxEdit">
        </div>     
        <div class="frame-foot">
            <div class="button closeGsButton" onclick='ConfirmFrame()'>确定</div>
        </div>
    </div>
    <!-- 逻辑运算 -->
    <div class="Logic">
        <div class="title">
            <span>逻辑运算</span>
            <span onclick="LogicClose()" style="cursor: pointer;color:#fff;float: right;">X</span>
        </div>
        <div class="LogicContent ">
            <button class="addButton" onclick="addLogic()">新增</button>
            <div>
                <span class="form-span">作者</span>
                <input id="ljName" type="text">
            </div>
            <div style="margin-top: 10px;">
                <span class="form-span">描述</span>
                <input id="ljDes" type="text">
            </div>
            <div style="margin-top: 10px;">
                <span class="form-span">逻辑运算名称<i style="color: red;font-size: 16px;display: inline-block">*</i></span>
                <input id="LogicName" type="text">
            </div>
            <div>
                <form class="logicForm">
                    <ul class="logicUl">
                        <li class="logicLi">
                            <select name="" class="Logic-form-field inputButton">
                                <option value="">请选择字段</option>
                            </select>
                            <select name="" class="Logic-form-label inputButton">
                                <option value="">与</option>
                                <option value="">或</option>
                                <option value="">非</option>
                                <option value="">&lt; </option>
                                <option value="">&lt;=</option>
                                <option value="">&gt; </option>
                                <option value="">&gt;=</option>
                                <option value="">=</option>
                            </select>
                            <!-- <select name="" class="Logic-form-value inputButton">
                                <option value="">请选择取值</option>
                            </select>  -->
                            <input type="text" class="Logic-form-value inputButton">
                            <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                        </li>
                    </ul>
                </form>
            </div>
        </div>
        <div class="frame-foot">
            <div class="button closeLjButton" onclick='ConfirmLogic()'>确定</div>
        </div>
    </div>
    <!-- 算法确认删除框 -->
    <div class="lkr-frame" id='lkrAlgorithm'>
        <div class="lkr-frame-div" style="height: 150px;">
            <div class="lkr-frame-content">
                <h3>
                    确认删除此算法?
                </h3>
                
            </div>
            <div class="lkr-frame-foot">
                <div class="lkr-button" onclick='ConfirmDelAlgorithm()' style="margin-right: 10px;">确定</div>
                <div class="lkr-button" onclick='AlgorithmeDelClose()'>取消</div>
            </div>
        </div>
    </div>
    <div class="lkr-frame" id='lkrFrameDel'>
        <div class="lkr-frame-div" style="height: 150px;">
            <!-- <div class="lkr-frame-tilte">
                删除
                <span style="cursor: pointer;" onclick='lkrFrameDelClose()'>x</span>
            </div> -->
            <div class="lkr-frame-content">
                <h3>
                    确认删除?
                </h3>
                
            </div>
            <div class="lkr-frame-foot">
                <div class="lkr-button" onclick='ConfirmDel()' style="margin-right: 10px;">确定</div>
                <div class="lkr-button" onclick='lkrFrameDelClose()'>取消</div>
            </div>
        </div>
    </div>
<!--       字典确定删除框-->
       <div class="lkr-frame" id='deleteZdDiv' style="z-index:20000;">
           <div class="lkr-frame-div" style="height: 150px;">
               <div class="lkr-frame-content">
                   <h3>
                       确认删除?
                   </h3>
               </div>
               <div class="lkr-frame-foot">
                   <div class="lkr-button" onclick='deleteZdYes()' id="deleteZdButton" style="margin-right: 10px;">确定</div>
                   <div class="lkr-button" onclick='closeDeleteZdDiv()'>取消</div>
               </div>
           </div>
       </div>
    <div class="lkr-frame" id='lkrFrame'>
        <div class="lkr-frame-div">
            <div class="lkr-frame-tilte">
                新建模型
                <span style="cursor: pointer;" onclick='lkrFrameClose()'>x</span>
            </div>
            <div class="lkr-frame-content">
                <div style="margin: 15px 0;display: flex;align-items: center;">
                    <label style="line-height: 10px;width: 120px;text-align: right;margin-right: 10px;">模型所属组<i style="color: red;font-size: 16px;display: inline-block">*</i> </label>
                    <input id='modulegroup' class="lkr-input" ondblclick="groupTreeDataShow(1)" placeholder="请双击选择分组">
                    <input type='text' id='modulegroupshow' class="lkr-input" style="display: none;"/>

                </div>
                <div style="margin: 15px 0;display: flex;align-items: center;">
                    <label style="line-height: 10px;width: 120px;text-align: right;margin-right: 10px;">模型名称<i style="color: red;font-size: 16px;display: inline-block">*</i> </label>
                    <input type='text' id='mouldName' maxlength="50" class="lkr-input"/>
                </div>
                <div style="margin: 15px 0;display: flex;align-items: center;">
                    <label style="line-height: 10px;width: 120px;text-align: right;margin-right: 10px;">描述 </label>
                    <textarea style="resize: none" type='text'  maxlength="500" id='mouldRemark' class="lkr-input"></textarea>

                </div>

                <div style="margin: 15px 0;display: flex;align-items: center;">
                    <label style="line-height: 10px;width:120px;text-align: right;margin-right: 10px;" class="sjyDiv">链接数据源 </label>
                    <div id='fgiSource' class="lkr-button">链接数据源</div>
                    <button class="addsjyth" type="button" onclick="addsjyth()">+</button>
                </div>
                <div id='addMb' >
                    <table class="lkr-table" border="1">
                        <thead>
                          <tr>
                            <td>
                                中文名称
                            </td>
                            <td>
                                英文名称
                            </td>
                            <td>
                                字段类型
                            </td>
                            <td>
                                字段表名
                            </td>
                            <td>
                                备注
                            </td>
                            
                            <td class="operate">
                                操作
                            </td>
                          </tr>
                        </thead>
                        <tbody class="dataSourceTbody">

                        </tbody>
                    </table>

                </div>
            </div>
            <div class="lkr-frame-foot">
                <div class="lkr-button" onclick='Confirm()'>确定</div>
            </div>
        </div>

    </div>
    <!-- 连线（lkr） -->
    <div class="lkr-frame" id='ligature'>
        <div class="lkr-frame-div" style="height: 150px;">
            <!-- <div class="lkr-frame-tilte">
                删除
                <span style="cursor: pointer;" onclick='lkrFrameDelClose()'>x</span>
            </div> -->
            <div class="lkr-frame-content">
                <input type='text'  class="lkr-input" style="flex:1;margin-left: 10px;"/>

            </div>
            <div class="lkr-frame-foot">
                <div class="lkr-button" onclick='ligatureConfirm()'>确定</div>
            </div>
        </div>
    </div>

    <!-- 连线（lkr） -->
    <div class="wrapper" style="height: 100%;">
        <!-- Content Wrapper. Contains page content -->
        <div class="content-wrapper">
            <section class="content" id="content">
                <div class="panel panel-default" style="background: rgba(0,0,0,0);border: none;">
                    <div class="panel-body">
                        <nav class="navbar navbar-default" style="padding: 0 10px;background-color: rgba(0,0,0,0);border: none;width: 80%;text-align: left">
                            <span style="color:#fff;">通用信号分析算法规则编排系统</span>
<!--                            <span style="color:#4cb1ff;">规则名称：</span><span id="currentGzName">&nbsp;</span>-->
<!--                            <span style="color:#4cb1ff;">规则描述：</span><span id="currentGzDes">&nbsp;</span>-->
<!--                            <ul class="nav nav-pills">-->
<!--                                <li><button id="saveRule" onclick="ruleOpen()">保存规则</button></li>-->
<!--                                <li><button id="Import">导入</button></li>-->
<!--                                <li><button id="export">导出</button></li>-->
<!--                            </ul>-->
                        </nav>
                        <div class="flex lkr-flex" id="main_canvas" >
                            <div id="canvasList">
                                <ul>
                                    <li class="pageson"><span class="canvasLi" canvasId="canvas0">画布1</span><i class="delCanvas">X</i></li>
                                </ul>
                            </div>
                            <div id="colorDiv">
                                <ul>
                                    <li style="background: #0eff23">常量</li>
                                    <li style="background: #ff00e7">模型</li>
                                    <li style="background: red">int</li>
                                    <li style="background: #a4ff59">long</li>
                                    <li style="background: #ff7749">byte</li>
                                    <li style="background: #fb61ff">short</li>
                                    <li style="background: blue">float</li>
                                    <li style="background: green">double</li>
                                    <li style="background: aqua">boolean</li>
                                    <li style="background: orange">number</li>
                                    <li style="background: #7cc6ff">char</li>
                                    <li style="background: #ff4286">date</li>
                                    <li style="background: #00c1ff">string</li>
                                    <li style="background: #6a46ff">blob</li>
                                    <li style="background: #ffe964">array</li>
                                </ul>
                            </div>
                            <!-- <div onclick="addFrame()" style="cursor: pointer;">新增</div> -->
                            <div class="yjl_tools">
                               
                                <div class="colorTpye">类型<i></i></div>
                                <button id="btn">全屏<i></i></button>
                                <div id="saveRule" onclick="ruleOpen()">暂存<i></i></div>
                                <div class="uploadDiv" onclick="uploadShow()">导入<i></i></div>
                                <div class="export">导出<i></i></div>
                                <div class="checkUp">检查<i></i></div>
                                <div class="deleteDiv">
                                    <a onclick="onDelete()">
                                        删除<i></i>
                                    </a>
                                    
                                </div>
                                <div class="undoDiv">
                                    <a onclick="undo()" class="menu-a">
                                        撤消<i></i>
                                    </a>
                                </div>
                                <div class="clearCanvas">
                                    清空<i></i>
                                </div>
                                <div class="newBuilt">
                                    新建<i></i>
                                </div>
                                <!-- <div type="button" class="fullScreen">全屏</div> -->
                            </div>
                            <div class="lkr-bg-canvas">
                                <div id="flex_canvas">
                                    <div id="topo_canvas" style=" width: 100%; height: 75vh;border: none;">

                                    </div>
                                </div>
                                
                                <!-- <iframe src="./canvas.html"  canvasId="canvas0" style=" width: 100%; height: 75vh;border: none;"></iframe> -->
                            </div>
                        </div>
                        <div class="props" id="flex_props1">
                            <div class="pv5">
                                <div id="flex_props1_home">
                                    <div>
                                        <div class="sub-title">
                                            提示：
                                        </div>
                                        <ul class="noticeList">
                                          
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="tools" id="flex_tools" style="position: absolute;right: 30px;border: 1px solid #19386f;border-radius: 7px;">
                            <div class="title-page">
                                <li><span onclick="dataModlue()"><i class="dataMod"></i>模型库</span></li>
                                <li><span onclick="dictionaryShow()"><i class="DicI"></i>算法库</span></li>
                                <li><span onclick="ruleGroupShow()"><i class="ruleI"></i>规则库</span></li>
                            </div>
                            <div class='Search'>
                                <div>
                                    <input id="searchName" type='text' onkeydown="keyup_submit(event)" class="search-input" style="margin: auto;color: white;width: 220px;height: 34px"/>
                                    <input type='button' onclick="searchData()" value="检索" style="background: #409eff;width: 80px;color: #fff;margin: 15px 0;margin-left: 1px;border: none;height: 32px;"/>
                                </div>
                            </div>
                            <!-- 模型库页-->
                            <div id="modelPageDiv" class='lkr-page'>
                                <ul id="moduleTree" class="ztree" style="height: 220px;overflow: auto;border-bottom: 1px dashed #084b69"></ul>
                                <div id="moduleListRight" style="height: 430px;overflow: auto">

                                </div>
                            </div>
                            <!-- 规则库页-->
                           <div id="ruleMde" class='lkr-page' style="display: none;">
                               <ul id="ruleTree" class="ztree" style="height: 220px;overflow: auto;border-bottom: 1px dashed #084b69"></ul>
                               <div id="ruleListRight" style="height:430px;overflow: auto">

                               </div>
                           </div>
                            <!--算法库页-->
                           <div id="algorithmPage" class='lkr-page' style="display: none">
                               <ul id="sfTree" class="ztree" style="height: 220px;overflow: auto;border-bottom: 1px dashed #084b69"></ul>
                               <div id="sfGruopListRight" style="height: 430px;overflow: auto">

                               </div>
                           </div>
                           <div class="mouldFoot">
                                <div class="activeTypeName dataManage" onclick="dataModify()">数据管理</div>
                                <div class="activeGroupName" onclick="gruopEdit()">分组维护</div>
                            </div>

                        </div>

                    <!--右键菜单定义-->
                    <div class="context-menus" id="canvas_menus" style="display: none">
                        <div id="showRk" style="display: none">
                            <a class="menu-a" onclick="showRk()">
                                算法备注
                            </a>
                        </div>
                        <div>
                            <a class="menu-a" id="showAllmag" style="display: none">
                                算法详情
                            </a>
                        </div>
                        <div>
                            <a class="menu-a" id="setAct" style="display: none">
                                设置动作
                            </a>
                        </div>
                        <div class="line"></div>
                        <!-- <div>
                            <a onclick="onLock()" class="menu-a-disabled" id="menu_lock" disabled>
                                锁定
                            </a>
                        </div> -->
                        <div class="line"></div>
                        <div>
                            <a onclick="onDelete()" class="menu-a  menu-a-delete">
                                删除
                            </a>
                        </div>
                        <div class="line"></div>
                        <div>
                            <a onclick="undo()" class="menu-a">
                                撤消
                                <span class="ml50">Ctrl + Z</span>
                            </a>
                        </div>
                        <div>
                            <a onclick="redo()" class="menu-a">
                                恢复
                                <span class="ml50">Ctrl + Shift+ Z</span>
                            </a>
                        </div>
                        <div class="line"></div>
                    </div>
                </div>
                </div>
            </section>
            <!-- /.content -->
        </div>
        <!-- /.content-wrapper -->

    </div>
       <!-- 规则详情信息弹窗 -->
       <div id="gzDiv">
           <div class="title" style="height: 50px;line-height: 40px">
               <span>规则信息</span>
               <span class="closeGzDiv" style="color:#fff;float: right;cursor: pointer;margin-right: 50px">X</span>
           </div>
           <div style="position: relative;top:40px;margin: 0 auto;margin-left:15px">
               <input type="button" value="导入规则" style="height: 30px;line-height: 30px;background: #409eff;border: none;color: #fff" onclick="uploadShow()">
           </div>
           <div style="position: relative;top:70px;margin: 0 auto;margin-left: 10px">
               <div style="height: 480px;overflow: auto">
                   <ul id="gzWinTree" class="ztree" style="width: 250px;float: left;overflow:auto;"></ul>
                   <table class="gzGruopTable" style="float: left;"></table>
               </div>
           </div>
       </div>
      <!-- 字典信息弹窗 -->
      <div id="dicDiv">
              <div class="title" style="height: 50px;line-height: 40px">
                  <span>算法信息</span>
                  <span class="dicDivClose" style="color:#fff;float: right;cursor: pointer;margin-right: 50px">X</span>
              </div>
              <div style="position: relative;top:70px;margin: 0 auto;margin-left: 10px">
                  <input type="button" id="addDic" value="新增算法">
                  <input type="button" id="addSzBuuton" onclick="editAlgorithm()" value="编辑算法">
                  <div style="height: 520px;overflow: auto">
                      <ul id="sfWinTree" class="ztree" style="width: 250px;float: left;overflow: auto"></ul>
                      <table class="sfGruopTable" style="float: left;"></table>
                  </div>
              </div>
      </div>
    <!-- 分组信息弹窗 -->
    <div id="groupDiv">
        <div class="title">
            <span>分组信息</span>
            <span class="groupDivClose" style="color:#fff;float: right;cursor: pointer;margin-right: 50px">X</span>
        </div>
        <div style="position: relative;top:70px;margin: 0 auto;margin-left: 30px">
            <input type="button" id="addGroup" value="新增分组">
            <input type="button" id="updateGroup" value="修改分组">
            <input type="button" id="deleteGroup" value="删除分组">
            <div style="height: 420px;overflow: auto">
                <ul id="groupDivTree" class="ztree" style="width: 250px;float: left;overflow: auto"></ul>
            </div>
        </div>
    </div>
       <!-- 树节点选择弹窗 -->
       <div id="groupTreeDiv">
           <div class="title">
               <span>分组详情</span>
               <span style="color:#fff;float: right;cursor: pointer;" onclick="closeGroupTreeDiv()">X</span>
           </div>
           <div style="position: relative;top:70px;margin: 0 auto;margin-left: 10px">
               <ul class="ztree" id="groupWinTree" style="height:350px;overflow: auto"></ul>
           </div>
           <input type="button" class="cancelGroupTree" value="取消">
       </div>
    <!-- 分组信息新增修改弹窗 -->
    <div id="groupEditDiv">
        <div class="title">
            <span class="groupTitle">新增分组</span>
            <span class="closeGroupEditDiv" style="float: right;cursor: pointer">X</span>
        </div>
        <div class="groupMain">
            <span style="width: 120px;margin-bottom: 15px">父分组名称</span>
            <input type="text" value="" id="parentGroup" ondblclick="groupTreeDivShow()" maxlength="100" readonly placeholder="请双击选择分组">
            <span style="width: 120px">分组名称</span>
            <input type="text" value="" id="groupInputName" maxlength="100">
        </div>
        <input type="button" id="addGroupYes" value="确定">
        <input type="button" class="cancelGroup" value="取消">
    </div>
    <!-- 字典新增修改弹窗 -->
    <div id="editDic">
        <div class="title">
            <span id="editDicTitle">新增算法</span>
            <span id="dictordySpan" class="editDicClose" style="color:#fff;float: right;cursor: pointer;">X</span>
        </div>
        <div style="position: relative;top: 70px;margin: 0 auto;">
            <h4 style="color:#fff;margin-left: 30px;color: aqua">基本信息</h4>
                <div style="margin-left: 30px">
                    <div style="margin: 8px 0">
                        <span> 作 者 </span><input type="text" id="editAuthor" style="width: 350px;height: 30px" maxlength="20">
                    </div>
                    <div style="margin: 8px 0">
                        <span>单位信息</span><input type="text" id="company" style="width: 350px;height: 30px" maxlength="100">
                    </div>
                    <div style="margin: 8px 0">
                        <span>算法名称<i style="color: red;font-size: 16px;display: inline-block">*</i></span><input type="text" id="editDicName" style="width: 350px;height: 30px" maxlength="200">
                    </div>
                    <div style="margin: 8px 0">
                        <span>算法描述</span><input type="text" id="editDicDes" style="width: 350px;height: 30px" maxlength="500">
                    </div>
                    <div>
                        <span>分组<i style="color: red;font-size: 16px;display: inline-block">*</i></span><input type="text" id="group" style="width: 350px;height: 30px" placeholder="请双击选择分组" ondblclick="groupTreeDataShow(2,1)">
                    </div>
                    <input type="text" value="" id="zdStatus" style="display: none">
                </div>
            <h4 style="color: aqua;margin: 20px 0 20px 30px">参数信息</h4>
            <button style="background: #409eff;color: #fff;margin-bottom: 20px;margin-left: 20px" id="addZdcs">新增参数</button>
            <div id="zdcsList"></div>
        </div>
        <button id="editDicYes">确定</button>
    </div>
<script src="config.js"></script>

<script src="./plugins/bootstrap/3.3.5/bootstrap.min.js"></script>
<script src="./plugins/bootstrap-colorpicker/dist/js/bootstrap-colorpicker.min.js"></script>
<script src="./plugins/topology/topology.bundle.js"></script>
<script src='index.js'></script>
<script src="topology/topology_es5.js"></script>
<script src="topology/MathJax.js"></script>
<script src="base.js"></script>
<link rel="stylesheet" href="base.css">

<script>
    var editGzType = false;
    var globalActionDatas = [];
    var zcData={};
    var currentLineData;
    var mxDataAll={};
    var sfDataAll = {};
    var gzDataAll = {};
    var modelSelectList;
    var deleteLineDataId;
    var currentActionInput;
    var responseActionDatas;
    var refreshId;
    var resCurrentLineData={
        dataIn:"",
        dataOut:""
    };
    var isRuleNow = true
    var canvasNowId = "canvas0"
    var setting={
        check: {

        },
        callback:{
            onClick:treeClick
        },
        data: {
            simpleData: {
                enable: true,
                idKey: "id",//节点id名
                pIdKey: "pid",//父节点id名
                rootPId: 0//默认根节点为0
            }
        },
        view:{
            showLine:false
        }
    };
    window.bigData = {
        mouldParam:[],
        actionTab:'基础模块',
        delmoduleId:'',
        editmoduleId:'',
        frameType:'add',
        editmoduledata:[],
        delAlgorithmId:'',
        editAlgorithmId:'',
        editFormula:'',
        formulaType:'add',
        formulaModuleId:'',
        isAddInOut:false,
        isAddInOutType: 'out',
        editRuleId:'',
        ruleType:'add',
        isExportId: '',
        isExportButton:false
    }
    window.filed ={
        inputFieldsTarget:'',
        fieldname:''
    }
    //时间格式
    var myDate = new Date();
    myDate.getYear();        // 获取当前年份(2位)
    myDate.getFullYear();    // 获取完整的年份(4位,1970-????)
    myDate.getMonth();       // 获取当前月份(0-11,0代表1月)
    myDate.getDate();        // 获取当前日(1-31)
    myDate.getDay();         // 获取当前星期X(0-6,0代表星期天)
    myDate.getTime();        // 获取当前时间(从1970.1.1开始的毫秒数)
    myDate.getHours();       // 获取当前小时数(0-23)
    myDate.getMinutes();     // 获取当前分钟数(0-59)
    myDate.getSeconds();     // 获取当前秒数(0-59)
    myDate.getMilliseconds();    // 获取当前毫秒数(0-999)
    myDate.toLocaleDateString();     // 获取当前日期
    var mytime=myDate.toLocaleTimeString();     // 获取当前时间
    myDate.toLocaleString( );        // 获取日期与时间

    // 对Date的扩展，将 Date 转化为指定格式的String
// 月(M)、日(d)、小时(h)、分(m)、秒(s)、季度(q) 可以用 1-2 个占位符，
// 年(y)可以用 1-4 个占位符，毫秒(S)只能用 1 个占位符(是 1-3 位的数字)
// 例子：
// (new Date()).Format("yyyy-MM-dd hh:mm:ss.S") ==> 2006-07-02 08:09:04.423
// (new Date()).Format("yyyy-M-d h:m:s.S") ==> 2006-7-2 8:9:4.18
 
Date.prototype.Format = function (fmt) { // author: meizz
    var o = {
        "M+": this.getMonth() + 1, // 月份
        "d+": this.getDate(), // 日
        "h+": this.getHours(), // 小时
        "m+": this.getMinutes(), // 分
        "s+": this.getSeconds(), // 秒
        "q+": Math.floor((this.getMonth() + 3) / 3), // 季度
        "S": this.getMilliseconds() // 毫秒
    };
    if (/(y+)/.test(fmt))
        fmt = fmt.replace(RegExp.$1, (this.getFullYear() + "").substr(4 - RegExp.$1.length));
    for (var k in o)
        if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
            return fmt;
}

 
    function getTime(){
        var timeDay = new Date().Format("yyyy-MM-dd hh:mm:ss");
        return timeDay
    }
    

    //拖拽弹框
    $('body').on('mousedown','.head-hidden',(event) =>{
        var e = event || window.event;
        let  obj=$("#ruleAct"),disX = 0, disY = 0;
        if(event.button==0){//判断是否点击鼠标左键  
            /*  
            * clientX和clientY代表鼠标当前的横纵坐标  
            * offset()该方法返回的对象包含两个整型属性：top 和 left，以像素计。此方法只对可见元素有效。  
            * bind()绑定事件，同样unbind解绑定，此效果的实现最后必须要解绑定，否则鼠标松开后拖拽效果依然存在  
            * getX获取当前鼠标横坐标和对象离屏幕左侧距离之差（也就是left）值，  
            * getY和getX同样道理，这两个差值就是鼠标相对于对象的定位，因为拖拽后鼠标和拖拽对象的相对位置是不变的  
            */  
            // 鼠标相对于div左侧位置
            disX = event.clientX-obj.offset().left;  
            disY= event.clientY-obj.offset().top;
            //movemove事件必须绑定到$(document)上，鼠标移动是在整个屏幕上的  
            $(document).bind("mousemove",move);  
            //此处的$(document)可以改为obj  
            $(document).bind("mouseup",stop); 
            
        }  
        return false;//阻止默认事件或冒泡  
        function move(event){ 

            let leftNum = 0,topnNum = 0
             // 获取浏览器可见区域宽高，div宽高
	        var browserWidth = document.documentElement.clientWidth,
	        browserHeight = document.documentElement.clientHeight,
	        boxWidth = document.getElementById('ruleAct').offsetWidth,
            boxHeight = document.getElementById('ruleAct').offsetHeight;
            leftNum =event.clientX-disX 
            if((leftNum -disX) < 0){
                leftNum = 0
            }
            if((leftNum+boxWidth) > browserWidth){
                leftNum = browserWidth -boxWidth
            }
            topnNum = event.clientY-disY 
            if(topnNum < 0){
                topnNum = 0
            }
            if((topnNum+boxHeight) >browserHeight){
                topnNum = browserHeight - boxHeight
            } 
            obj.css({  
                "left":leftNum+"px",  
                "top":topnNum+"px"  
            });  
            return false;//阻止默认事件或冒泡  
        }  
        function stop(){  
            //解绑定，这一步很必要，前面有解释  
            $(document).unbind("mousemove",move);  
            $(document).unbind("mouseup",stop);  
            
        }
    })
    document.addEventListener("fullscreenchange", function( event ) {
        if(window.canvasNowId == "canvas0"){
            if (document.fullscreenElement) {
                $('#topo_canvas').css({
                    // "background-color":"#fff",
                    "background-image": "url('./static/bigbg.jpg')",
                    "background-size": "100% 100%",
                    "background-repeat": "no-repeat",
                })
                window.canvas.lock(1)
                window.canvas.scale(1)
                console.log("全屏")
                $('#topo_canvas').off().on('dblclick',function(){
                        html2canvas(document.querySelector("#topo_canvas")).then(canvas => {
                            imgUrl = canvas.toDataURL("image/png").replace("image/png", "image/octet-imgUrleam")
                            var saveFile = function(data, filename){
                            //这个地址我也不知道有什么用
                            //(属于XML方法)createElementNS() 方法可创建带有指定命名空间的元素节点。
                            //此方法可返回一个 Element 对象。
                                var save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a');
                                save_link.href = data;
                                save_link.download = filename;
                                //MouseEvents 貌似为固定值
                                //CreateEvent是一个Windows API函数。它用来创建或打开一个命名的或无名的事件对象
                                var event = document.createEvent('MouseEvents');
                                event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                                save_link.dispatchEvent(event);
                            };
                            var filename = (new Date()).getTime() + '.' + 'jpg';
                            saveFile(imgUrl,filename);
                            document.exitFullscreen ? document.exitFullscreen() :
                            document.mozCancelFullScreen ? document.mozCancelFullScreen() :
                            document.webkitExitFullscreen ? document.webkitExitFullscreen() : '';

                        });
                });
            } else {
                $('#topo_canvas').css({
                    // "background-color":"#fff",
                    "background-image": "url('./static/lkr.png')",
                    "background-size": "100% 100%",
                    "background-repeat": "no-repeat",
                    "width":"1505px",
                    "height":"726px",
                    "box-shadow": "0 0 10px 10px rgba(0,0,0,0.2)",
                    "border-radius": "8px"
                })
                $('#topo_canvas').off('dblclick')
                window.canvas.lock(0)
                window.canvas.scale(1)
                window.canvas.data.nodes.map(item=>{
                    if(!item.childStand){
                        item.anchors.map((obj,i) => {
                            obj.x = 0;
                            obj.y = 0;
                        })
                        item.rotatedAnchors.map((obj,i) => {
                            obj.x = 0;
                            obj.y = 0
                        })
                    }
                })
                console.log("不是全屏")
            }
        }else{
            if (document.fullscreenElement) {
                $('#'+window.canvasNowId).contents().find("#topo_canvas").css({
                    // "background-color":"#fff",
                    "background-image": "url('./static/bigbg.jpg')",
                    "background-size": "100% 100%",
                    "background-repeat": "no-repeat",
                    "z-index":"999",
                    "position": "absolute",
                    "width":"1920px",
                    "height":"1080px",
                })
                document.getElementById(window.canvasNowId).style.height=window.screen.height+"px";
                document.getElementById(window.canvasNowId).style.width=document.documentElement.clientWidth+"px";
                document.getElementById(window.canvasNowId).style.zIndex="9999999";
	            document.getElementById(window.canvasNowId).style.position="absolute"
                document.getElementById(window.canvasNowId).style.left="-10px";
                document.getElementById(window.canvasNowId).style.top="-10px";
                parent.$(".navbar-default").hide();
                parent.$('#'+window.top.canvasNowId)[0].contentWindow.canvas.lock(1)
                parent.$('#'+window.top.canvasNowId)[0].contentWindow.canvas.scale(1)

                $('#'+window.canvasNowId).contents().find('#topo_canvas').off().on('dblclick',function(e){
                    var a = $(e.target).parent("#topo_canvas")
                    html2canvas(a[0]).then(canvas => {
                        imgUrl = canvas.toDataURL("image/png").replace("image/png", "image/octet-imgUrleam")
                        var saveFile = function(data, filename){
                        //这个地址我也不知道有什么用
                        //(属于XML方法)createElementNS() 方法可创建带有指定命名空间的元素节点。
                        //此方法可返回一个 Element 对象。
                            var save_link = document.createElementNS('http://www.w3.org/1999/xhtml', 'a');
                            save_link.href = data;
                            save_link.download = filename;
                            //MouseEvents 貌似为固定值
                            //CreateEvent是一个Windows API函数。它用来创建或打开一个命名的或无名的事件对象
                            var event = document.createEvent('MouseEvents');
                            event.initMouseEvent('click', true, false, window, 0, 0, 0, 0, 0, false, false, false, false, 0, null);
                            save_link.dispatchEvent(event);
                        };
                        var filename = (new Date()).getTime() + '.' + 'jpg';
                        saveFile(imgUrl,filename);
                        document.exitFullscreen ? document.exitFullscreen() :
                        document.mozCancelFullScreen ? document.mozCancelFullScreen() :
                        document.webkitExitFullscreen ? document.webkitExitFullscreen() : '';

                    });
                });
            } else {
                $('#'+window.canvasNowId).contents().find("#topo_canvas").css({
                    // "background-color":"#fff",
                    "background-image": "url('./static/lkr.png')",
                    "background-size": "100% 100%",
                    "background-repeat": "no-repeat",
                    "width":"1505px",
                    "height":"726px",
                    "zIndex":"0",
                    "border-radius": "8px"
                })
                $('#'+window.canvasNowId).contents().find('#topo_canvas').off('dblclick')
                parent.$(".navbar-default").show();
                document.getElementById(window.canvasNowId).style.height="75vh";
                document.getElementById(window.canvasNowId).style.width="100%";
                document.getElementById(window.canvasNowId).style.zIndex="2";
                document.getElementById(window.canvasNowId).style.left="10px";
                document.getElementById(window.canvasNowId).style.top="0px";
                parent.$('#'+window.top.canvasNowId)[0].contentWindow.canvas.lock(0)
                parent.$('#'+window.top.canvasNowId)[0].contentWindow.canvas.scale(1)
                parent.$('#'+window.top.canvasNowId)[0].contentWindow.canvas.data.nodes.map(item=>{
                    if(!item.childStand){
                        item.anchors.map((obj,i) => {
                            obj.x = 0;
                            obj.y = 0;
                        })
                        item.rotatedAnchors.map((obj,i) => {
                            obj.x = 0;
                            obj.y = 0
                        })
                    }
                })
            }
        }
        
    });

    $('body').on('click','.checkUp',(e) =>{
        $('.noticeList').append(`<li>${parent.getTime()} 检查成功！</li>`)
        parent.toastr.success('检查成功！')
        $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
    })
    // 新建画布窗口
    var tiemer = "";
    var time = 3000;//每次点击三秒后才能再次点击
    var fun = function bClick(){
        if ($("#canvasList").css("display") == "none") {
            $("#canvasList").show()
            $('#canvasList ul li').eq(0).addClass('pageson').show();
            $('#canvasList ul li').eq(0).find("span").text("画布1")
            $("#flex_canvas").show();
            window.canvasNowId ="canvas0"
        }else{
            $("#ruleName").val("");
            $("#ruleRemark").val("");
            $("#gzGroupName").val("");
            let leg =Date.now().toString(16).substring(Date.now().toString(16).length-6)      
            let canvas_id = "canvas"+leg
            var c="<iframe src='./canvas.html' id='"+canvas_id+"' style='width: 100%; height: 75vh;border: 0;' scrolling='no' allowtransparency='yes' marginwidth='0' marginheight='0' frameborder='0'></iframe>"
            $(".lkr-bg-canvas").append(c)
            $('.lkr-bg-canvas').children().hide();
            $('#'+canvas_id).show()
            $('#'+canvas_id)[0].contentWindow.canvasNowId = canvas_id
            window.canvasNowId = canvas_id
            $('#'+canvas_id)[0].contentWindow.isRuleNow =true
            if( $('#canvasList ul li').length == 1){
                $('#canvasList ul li').eq(0).removeClass('pageson');
            }else{
                $('#canvasList ul li').siblings().removeClass('pageson');
            }
            let canvasNum = 1
            
            $("#canvasList ul li").each((i,v) => {
                let items = $(v)
                let  canvasName = items.children(".canvasLi").text()
                if( canvasName.indexOf("画布") != -1){
                    canvasName = canvasName.slice(2)
                }
               
                if(Number(canvasName)>= canvasNum ){

                    canvasNum  = canvasName
                   
                }
            })
            let newCanvasName = "画布"+ (Number(canvasNum)+1)
            $('#canvasList ul').append(`<li class="pageson"><span class="canvasLi" canvasId="${canvas_id}">${newCanvasName}</span> <i class="delCanvas">X</i></li>`)  
            $(".newBuilt").unbind("click");
            tiemer = setTimeout(function(){
                $(".newBuilt").click(fun);
            },time);
        }
       
     
    };
    $(".newBuilt").click(fun);
   
    $('body').on('click','#setAct',(e) =>{
        $("#actionDiv").show();
        var data,datas,local,res;
        if(window.top.canvasNowId == "canvas0"){
            data = currentLineData;
            datas = canvas.data;
            local = globalActionDatas;
            res =responseActionDatas
        }else{
            data = parent.$('#'+window.top.canvasNowId)[0].contentWindow.currentLineData;
            datas = parent.$('#'+window.top.canvasNowId)[0].contentWindow.canvas.data;
            local = parent.$('#'+window.top.canvasNowId)[0].contentWindow.globalActionDatas;
            res = parent.$('#'+window.top.canvasNowId)[0].contentWindow.responseActionDatas
        }
        let id_in;//输入端算法id
        let id_out;//输出端算法id
        parent.$("#actionMsgIn").val("");
        parent.$("#actionMsgOut").val("");
        parent.$("#actionMsgIn").show();
        parent.$("#actionMsgOut").hide();
        parent.$(".menu-a-delete").css("display", "block");
        parent.$("#addActionButton").attr({
            actionRelation:"",
            preActionRelation:""
        })
        parent.$("#addActionButton").attr("resData","false")
        datas.nodes.map(s=>{
            if(s.id == data.from.id){
                id_out = s.childStand.fid
            }
            if(s.id == data.to.id){
                id_in = s.childStand.fid
            }
        })
        if(window.canvasNowId != "canvas0"){
            parent.$('#'+window.top.canvasNowId)[0].contentWindow.selLines =[data]
        }
        var bigOutName,smallOutName,bigInName,smallInName,out_big,in_big,fromParmaChinese;
        var bigList=[];
        datas.nodes.map(s=>{
            if(s.id == data.from.id){
                smallOutName = s.childStand.cstext;
                out_big = s.childStand.fUUid;
            }
            if(s.id == data.to.id){
                smallInName = s.childStand.cstext;
                in_big = s.childStand.fUUid;
            }
        })
        datas.nodes.map(s=>{
            if(s.id == out_big){
                bigOutName = s.text;
            }
            if(s.id == in_big){
                bigInName = s.text;
            }
        })
        datas.nodes.map(s=>{
            if(s.id == data.to.id){
                fromParmaChinese = s.childStand.cstext
            }
        })
        $.ajax({
            url:urlConfig.host+'/operatorMaintenance/getAlgorithmById',
            data:{algthId:id_in},
            success(response) {
                response.tableFuncs.map(s=>{
                    if(s.parametername == fromParmaChinese){
                        parent.$('#addActionButton').attr("from_name",s.varname);
                        parent.$('#addActionButton').attr("from_id",s.id);
                    }
                })
                parent.$("#actionInDiv .xwzly_in").each((i,s)=>{
                    parent.$(s).val(parent.$('#addActionButton').attr("from_name"));
                    parent.$(s).attr(parent.$('#addActionButton').attr("from_id"))
                })
            }
        })
        parent.$("#selectOutIn").empty();
        parent.$("#selectOutIn").append(`<option value="1">${bigInName}的输入参数</option><option value="2">${bigOutName}的输出参数</option>`)
        parent.$('#selectOutIn').val('1')

        let out_small = data.from.id.split('---')[0]//输出小矩形uuid
        let in_small =  data.to.id.split('---')[0]//输入小矩形uuid
        parent.$("#addActionButton").attr({id_out,id_in,out_big,out_small,in_big,in_small})
        window.lineDiv = true;

        parent.$("#actionInDiv").empty();
        parent.$("#actionOutDiv").empty();

        var localData = true;//使用本地缓存数据
        var responseCurrentData = false;
        var resBaseOut;
        var resBaseIn;
        if(res){//后台返回数据
            res.map(t=>{
                if((t.preParametersID == out_small) && (t.parametersID == in_small)){
                    responseCurrentData= t;
                    resBaseOut = [];
                    resBaseIn = [];
                    localData = false;
                }
            })
            if(responseCurrentData){
                parent.$("#actionMsgIn").val(responseCurrentData.actionRelation)
                parent.$("#actionMsgOut").val(responseCurrentData.preActionRelation)
                parent.$("#addActionButton").attr({
                    actionRelation:responseCurrentData.actionRelation,
                    preActionRelation:responseCurrentData.preActionRelation
                })
                responseCurrentData.algorithmconditions.map(s=>{
                    if(responseCurrentData.preParametersID ==  s.interfaceparametersid){//输出
                        resBaseOut.push(s)
                    }
                    if(responseCurrentData.parametersID ==  s.interfaceparametersid){//输入
                        resBaseIn.push(s)
                    }
                })
                var resOutAll = {
                    "interfaceRoleDataModels":
                        {
                            "algorithmconditions":resBaseOut,
                            "des": "",
                            "id": responseCurrentData.id,
                            "interfaceID": responseCurrentData.interfaceID,
                            "parametersID":responseCurrentData.parametersID,
                            "preInterfaceID": responseCurrentData.preInterfaceID,
                            "preParametersID": responseCurrentData.preParametersID,
                            "remark": "",
                            "roleid": responseCurrentData.roleid,
                        }
                }
                var resInAll = {
                    "interfaceRoleDataModels":
                        {
                            "algorithmconditions": resBaseIn,
                            "des": "",
                            "id": responseCurrentData.id,
                            "interfaceID": responseCurrentData.interfaceID,
                            "parametersID": responseCurrentData.parametersID,
                            "preInterfaceID": responseCurrentData.preInterfaceID,
                            "preParametersID": responseCurrentData.preParametersID,
                            "remark": "",
                            "roleid": responseCurrentData.roleid,
                        }
                }
                resCurrentLineData.dataIn = resInAll;
                resCurrentLineData.dataOut = resOutAll;
                parent.$("#addActionButton").attr("resData","true")
                try{
                    resBaseIn.map((t,i)=>{
                        parent.$("#actionInDiv").append(`
                                                  <div style="margin: 10px 0" actionId=${t.id}>
                                                       <i>${i+1}</i>
                                                       <span>行为值来源</span><input class="xwzly_in" disabled>
                                                       <span>行为</span><select class="xwSelect_in">
                                                       <option value=">">></option>
                                                       <option value="<"><</option>
                                                       <option value="=">=</option>
                                                       <option value=">=">>=</option>
                                                       <option value="<="><=</option>
                                                       <option value="!=">!=</option>
                                                       <option value="assignment">赋值</option>
                                                   </select>
                                                       <span>表达式</span><input type="text" value="${t.expression}" class="bds_in">
                                                       <button class="addLjgx" type="button"  style="background: #409eff;color: #fff;margin-left: 5px;height: 20px;border: none;width: 22px">+</button>
                                                       <button class="deleteActionData" type="button"  style="background: #f56c6c;color: #fff;margin-left: 10px;height: 20px;border: none">X</button>
                                                  </div>
                                            `)
                    })
                    resBaseIn.map((t,i)=>{
                        parent.$('#actionDiv .xwSelect_in').eq(i).val(t.behavior)
                    })

                    $.ajax({
                        url:urlConfig.host+'/operatorMaintenance/getAlgorithmById',
                        data:{algthId:parent.$("#addActionButton").attr("id_out")},
                        success(res) {
                            let optionx = "";
                            res.tableFuncs.map(s=>{
                                optionx += `<option value=${s.id} type=${s.vartype} valvalue=${s.valvalue}>${s.varname}</option>`
                            })
                            resBaseOut.map((t,i)=>{
                                parent.$("#actionOutDiv").append(`
                                                          <div style="margin: 10px 0" actionId=${t.id}>
                                                               <i>${i+1}</i>
                                                               <span>行为值来源</span><select class="xwzly_out">${optionx}</select>
                                                               <span>行为</span><select class="xwSelect_out">
                                                               <option value=">">></option>
                                                               <option value="<"><</option>
                                                               <option value="=">=</option>
                                                               <option value=">=">>=</option>
                                                               <option value="<="><=</option>
                                                               <option value="!=">!=</option>
                                                               <option value="assignment">赋值</option>
                                                           </select>
                                                               <span>表达式</span><input type="text" value="${t.expression}" class="bds_out">
                                                               <button class="addLjgx" type="button"  style="background: #409eff;color: #fff;margin-left: 5px;height: 20px;border: none;width: 22px">+</button>
                                                               <button class="deleteActionData" type="button"  style="background: #f56c6c;color: #fff;margin-left: 10px;height: 20px;border: none">X</button>
                                                          </div>
                                                    `)
                            })
                            resBaseOut.map((t,i)=>{
                                parent.$('#actionOutDiv .xwzly_out').eq(i).val(t.valuesources)
                                parent.$('#actionOutDiv .xwSelect_out').eq(i).val(t.behavior)
                            })
                            parent.$(".xwzly_out").off("change").on("change",(e)=>{
                                if($(e.target).find('option:selected').attr('type') == 3){
                                    $(e.target).next().next().empty();
                                    $(e.target).next().next().append(`<option value="assignment">赋值</option>`)
                                } else {
                                    $(e.target).next().next().empty();
                                    $(e.target).next().next().append(`<option value=">">></option>
                               <option value="<"><</option>
                               <option value="=">=</option>
                               <option value=">=">>=</option>
                               <option value="<="><=</option>
                               <option value="!=">!=</option>
                               <option value="assignment">赋值</option>`)
                                }
                            })
                            parent.$(".xwzly_out").each((i,s)=>{
                                if($(s).find('option:selected').attr('type') == 3){
                                    try {
                                        $(s).next().next().empty();
                                        $(s).next().next().append(`<option value="assignment">赋值</option>`)
                                    }catch (e) {
                                        console.log(e);
                                    }
                                }
                            })
                        }
                    })
                } catch (e) {
                    console.log(e);
                }
            }
        }
        if(localData){//本地缓存数据
            local.map(s=>{
                if(s.id == out_small + "AND" + in_small){
                    try{
                        parent.$("#actionMsgIn").val("");
                        parent.$("#actionMsgIn").val(s.dataIn.interfaceRoleDataModels.actionRelation);
                        parent.$("#actionMsgOut").val(s.dataOut.interfaceRoleDataModels.preActionRelation);
                        var lineDatas = s.dataIn.interfaceRoleDataModels.algorithmconditions;
                        var lineDatasOut = s.dataOut.interfaceRoleDataModels.algorithmconditions;
                        lineDatas.map((t,i)=>{
                            parent.$("#actionInDiv").append(`
                                                     <div style="margin: 10px 0">
                                                           <i>${i+1}</i>
                                                           <span>行为值来源</span><input class="xwzly_in" disabled>
                                                           <span>行为</span><select class="xwSelect_in">
                                                           <option value=">">></option>
                                                           <option value="<"><</option>
                                                           <option value="=">=</option>
                                                           <option value=">=">>=</option>
                                                           <option value="<="><=</option>
                                                           <option value="!=">!=</option>
                                                           <option value="assignment">赋值</option>
                                                            </select>
                                                           <span>表达式</span><input type="text" value="${t.expression}" class="bds_in">
                                                           <button class="addLjgx" type="button"  style="background: #409eff;color: #fff;margin-left: 5px;height: 20px;border: none;width: 22px">+</button>
                                                           <button class="deleteActionData" type="button"  style="background: #f56c6c;color: #fff;margin-left: 10px;height: 20px;border: none">X</button>
                                                     </div>
                                                `)
                        })
                        lineDatas.map((t,i)=>{
                            parent.$('#actionInDiv .xwSelect_in').eq(i).val(t.behavior)
                        })
                        $.ajax({
                            url:urlConfig.host+'/operatorMaintenance/getAlgorithmById',
                            data:{algthId:parent.$("#addActionButton").attr("id_out")},
                            success(res) {
                                let optionx = "";
                                res.tableFuncs.map(s => {
                                    optionx += `<option value=${s.id} type=${s.vartype} valvalue=${s.valvalue}>${s.varname}</option>`
                                })
                                lineDatasOut.map((t,i)=>{
                                    parent.$("#actionOutDiv").append(`
                                                             <div style="margin: 10px 0">
                                                                   <i>${i+1}</i>
                                                                   <span>行为值来源</span><select class="xwzly_out">${optionx}</select>
                                                                   <span>行为</span><select class="xwSelect_out">
                                                                   <option value=">">></option>
                                                                   <option value="<"><</option>
                                                                   <option value="=">=</option>
                                                                   <option value=">=">>=</option>
                                                                   <option value="<="><=</option>
                                                                   <option value="!=">!=</option>
                                                                   <option value="assignment">赋值</option>
                                                                    </select>
                                                                   <span>表达式</span><input type="text" value="${t.expression}" class="bds_out">
                                                                   <button class="addLjgx" type="button"  style="background: #409eff;color: #fff;margin-left: 5px;height: 20px;border: none;width: 22px">+</button>
                                                                   <button class="deleteActionData" type="button"  style="background: #f56c6c;color: #fff;margin-left: 10px;height: 20px;border: none">X</button>
                                                             </div>
                                                        `)
                                })
                                lineDatasOut.map((t,i)=>{
                                    parent.$('#actionOutDiv .xwzly_out').eq(i).val(t.valuesources)
                                    parent.$('#actionOutDiv .xwSelect_out').eq(i).val(t.behavior)
                                })
                                parent.$(".xwzly_out").off("change").on("change",(e)=>{
                                    if($(e.target).find('option:selected').attr('type') == 3){
                                        $(e.target).next().next().empty();
                                        $(e.target).next().next().append(`<option value="assignment">赋值</option>`)
                                    } else {
                                        $(e.target).next().next().empty();
                                        $(e.target).next().next().append(`<option value=">">></option>
                                                               <option value="<"><</option>
                                                               <option value="=">=</option>
                                                               <option value=">=">>=</option>
                                                               <option value="<="><=</option>
                                                               <option value="!=">!=</option>
                                                               <option value="assignment">赋值</option>`)
                                    }
                                })
                                parent.$(".xwzly_out").each((i,s)=>{
                                    if($(s).find('option:selected').attr('type') == 3){
                                        try {
                                            $(s).next().next().empty();
                                            $(s).next().next().append(`<option value="assignment">赋值</option>`)
                                        }catch (e) {
                                            console.log(e);
                                        }
                                    }
                                })
                            }
                        })
                    } catch (e) {
                        console.log(e);
                    }
                }
            })
        }
        setTimeout(()=>{
            if(window.lineDiv){
                parent.$('#actionDiv').show();
            }
        },300)
        parent.$('#actionInDiv').show();
    })
    $('body').on('click','.canvasLi',(e) =>{
        $('.lkr-bg-canvas').children().hide();
        let idC = $(e.target).attr("canvasId")
        $(e.target).parent("li").siblings().removeClass('pageson');
        $(e.target).parent("li").addClass('pageson');
        if(idC == "canvas0"){
            $("#flex_canvas").show();
            window.canvasNowId ="canvas0"
        }else{
            $('#'+idC).show()
            window.canvasNowId = idC
            // $('#'+idC)[0].contentWindow.canvasNowId = idC
        }
        
    })
    
    $('body').on('click','.delCanvas',(e) =>{
        let delID = $(e.target).prev().attr("canvasid")
        let nowID = $("#canvasList ul li.pageson").find("span").attr("canvasid")
        if(delID == "canvas0"){
            $(e.target).parent("li").hide();
            $("#flex_canvas").hide();
            window.canvas.data.nodes = []
            window.canvas.data.lines = []
            window.Topology.tools = {}
            window.globalActionDatas =[]
            window.bigData.ruleType ="add"
            canvas.render();
            if($("#canvasList ul li").length > 1){
                $('.lkr-bg-canvas').children().hide();
                let showId =$(e.target).parent("li").next().find("span").attr("canvasid")
                $(e.target).parent("li").next().addClass('pageson');
                $('#'+showId).show()
                window.canvasNowId =showId
                $('#'+showId)[0].contentWindow.canvasNowId = showId
            }
        }else if(delID == nowID && delID != "canvas0"){
            $(e.target).parent("li").siblings().removeClass('pageson');
            $(e.target).parent("li").prev().addClass('pageson');
            let showId =$(e.target).parent("li").prev().find("span").attr("canvasid")
            $(e.target).parent("li").remove();
            var iframe = $('#' + delID).prop('contentWindow');    
            $('#' + delID).attr('src', 'about:blank');       
            try{ 
                iframe.document.write(''); 
                iframe.document.clear(); 
            }catch(e){} 
            $('#' + delID).remove(); 
            $('.lkr-bg-canvas').children().hide();
            let leg = $('.lkr-bg-canvas').children().length
            if(showId == "canvas0"){
                $("#flex_canvas").show();
                window.canvasNowId ="canvas0"
            }else{
                $('#'+showId).show()
                window.canvasNowId =showId
                $('#'+showId)[0].contentWindow.canvasNowId = showId
            }
        }else if(delID != nowID && delID != "canvas0"){
            $(e.target).parent("li").remove();
            var iframe = $('#' + delID).prop('contentWindow');    
            $('#' + delID).attr('src', 'about:blank');       
            try{ 
                iframe.document.write(''); 
                iframe.document.clear(); 
            }catch(e){} 
            $('#' + delID).remove(); 
        }
        if($("#canvasList ul li").length == 1 && $("#canvasList ul li").eq(0).css("display") == "none"){
            $("#canvasList").hide()
            $("#flex_canvas").hide();
        } 
    })
    $('body').on('click','.export',(e) =>{
        let isExportId
        if(window.canvasNowId == "canvas0"){
            window.bigData.isExportButton = true
            isExportId  =window.bigData.isExportId
        }else{
           window.frames[canvasNowId].contentWindow.bigData.isExportButton = true
           isExportId =window.frames[canvasNowId].contentWindow.bigData.isExportId
        }
       
       if(isExportId == "") {
        $("#sureRule").show()
            $.ajax({
            url:urlConfig.host+ '/group/findAllGroupMessagesByType',
            data:{type:3},
            success(res) {
                if(res.length == 0){
                    $('.noticeList').append(`<li>${parent.getTime()} 请先添加分组！</li>`)
                    parent.toastr.info(`请先添加分组!` )
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    return
                }
                $("#gzGroupName").val("")
            }
        })
       }else{
        location.href= urlConfig.host+'/algorithmRule/saveAlgorithmRule2File?id=' + isExportId
        if(window.canvasNowId == "canvas0"){
            window.bigData.isExportButton = false
        }else{
            window.frames[canvasNowId].contentWindow.bigData.isExportButton = false
        }
       }
       

    })
    $('body').on('click','.colorTpye',(e) =>{
        $("#colorDiv").fadeToggle(500)
    })
    $('body').on('click','#btn',(e) =>{
        canvas.lock(2)
        canvas.scale(1)
    })
    
    $('body').on('click','.clearCanvas',(e) =>{
        let ruleType, isRuleNow
        if(window.canvasNowId == "canvas0"){
            ruleType = window.bigData.ruleType
            isRuleNow =window.isRuleNow
        }else{
            ruleType = parent.$('#'+window.top.canvasNowId)[0].contentWindow.bigData.ruleType
            isRuleNow = parent.$('#'+window.top.canvasNowId)[0].contentWindow.isRuleNow
        } 
        if(ruleType == "edit" && !isRuleNow){
            parent.$('.noticeList').append(`<li>${parent.getTime()} 当前规则有修改，请先暂存规则，再清空画布！ </li>`)
            parent.toastr.info(`当前规则有修改，请先暂存规则，再清空画布！` )
            parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
            return false
        }
        if(window.canvasNowId == "canvas0"){
            window.canvas.data.nodes = []
            window.canvas.data.lines = []
            window.Topology.tools = {}
            window.globalActionDatas =[]
            window.bigData.ruleType ="add"
            canvas.render();
        }else{
            window.frames[canvasNowId].contentWindow.canvas.data.nodes = []
            window.frames[canvasNowId].contentWindow.canvas.data.lines = []
            window.frames[canvasNowId].contentWindow.Topology.tools = {}
            window.frames[canvasNowId].contentWindow.globalActionDatas =[]
            window.frames[canvasNowId].contentWindow.bigData.ruleType ="add"
            window.frames[canvasNowId].contentWindow.canvas.render();
        }
        //location.reload();
    })
    function changeVarType(e){
        if(e.target.value == "2"){
            $(e.target).parent().next().find('input').remove();
            $(e.target).parent().next().find('select').remove();
            $(e.target).parent().next().find('span').text("取值")
            $(e.target).parent().next().append(`<input type="text" value=""  class="zdcsText">`)
        } else if(e.target.value == "3"){
            $(e.target).parent().next().find('input').remove();
            $(e.target).parent().next().find('select').remove();
            $(e.target).parent().next().find('span').text("模型名称")
            $(e.target).parent().next().append(modelSelectList)
        } else {
            $(e.target).parent().next().find('input').remove();
            $(e.target).parent().next().find('select').remove();
            $(e.target).parent().next().find('span').text("数据项")
            $(e.target).parent().next().append(`
                    <select class="zdcsTypeSelect">
                        <option>int</option>
                        <option>long</option>
                        <option>byte</option>
                        <option>short</option>
                        <option>float</option>
                        <option>double</option>
                        <option>boolean</option>
                        <option>number</option>
                        <option>char</option>
                        <option>date</option>
                        <option>string</option>
                        <option>blob</option>
                        <option>array</option>
                    </select>`)
        }
    }

    $('body').on('click','.lkr-list-edit',(e) => {
        window.bigData.frameType = 'edit'
        window.bigData.editmoduleId = $(e.target).attr('moduleId')
        $("#dataModulePage").show()
        $('#lkrFrame').fadeToggle(500)
        $('.addsjyth').show();
        $("#lkrFrame .lkr-button").show();
        $("#modulegroup").val("")
        $.ajax({
            url:urlConfig.host+'/module/getModuleById',
            data:{moduleId:window.bigData.editmoduleId},
            success: function(data) {
                let str =`修改模型
                    <span style="cursor: pointer;" onclick='lkrFrameClose()'>x</span>`
                $(".lkr-frame-tilte").html(str)
                $('.sjyDiv').show();
                $('.operate').show();
                $('#fgiSource').show();
                $('.addsjyth').show();
                $("#modulegroup").val(data.modulegroup).removeAttr("readonly")
                $("#mouldName").val(data.modulename).removeAttr("readonly")
                $("#mouldRemark").val(data.des).removeAttr("readonly")
                window.bigData.editmoduleId = data.id
                let thStr=``
                data.modulefields.map(item => {
                    thStr += `<tr id="${item.id}" moduleid="${item.moduleid}">
                    <td class="columnComment"><input type="text" value="${item.fieldname?item.fieldname:''}"></td> 
                    <td class="columnName"><input type="text" value="${item.englishname?item.englishname:''}"></td>
                    <td class="columnType" style="position:relative;width: 110px"><input type="text" class="moduleInputOne" value="${item.fieldtype?item.fieldtype:''}" style="background-color: rgba(0,0,0,0);border: none;outline: none;background-image: url(./static/select.png);background-size: 100% 100%;background-repeat: no-repeat;height: 30px;position: absolute;left:5px;top: 5px;width: 70px">
                        <select class="moduleSelect" onchange="zdlxChange($(this))">
                            <option value="byte">byte</option>
                            <option value="short">short</option>
                            <option value="int">int</option>
                            <option value="long">long</option>
                            <option value="float">float</option>
                            <option value="double">double</option>
                            <option value="boolean">boolean</option>
                            <option value="char">char</option>
                            <option value="date">date</option>
                            <option value="string">string</option>
                            <option value="blob">blob</option>
                            <option value="array">array</option>
                        </select>
                        </td>           
                    <td class="tableName"><input type="text" value="${item.tablename?item.tablename:''}"></td>
                    <td class="columnRemark"><input type="text" value="${item.remark?item.remark:''}"></td>
                    <td><img src="static/delete.png"  onclick="delTab(event)" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer"></td></tr>`
                })
                $('#addMb tbody').html(thStr)
            }
        })
    })
    function myFunction(e){
        $(e.target).parent('.columnType').children('.moduleSelect').show()
        $(e.target).parent('.columnType').children('.moduleInputOne').hide()
    }

    $('body').on('dblclick','.dbclickModule',(e) =>{
        let modlueId= $(e.target).attr('moduleId')
        $('#lkrFrame').fadeToggle(500)
        $.ajax({
            url:urlConfig.host+'/module/getModuleById',
            data:{moduleId:modlueId},
            success: function(data) {
                // $('#addMb tbody').html('')
                let str =`模型详情
                <span style="cursor: pointer;" onclick='lkrFrameClose()'>x</span>`
                $(".lkr-frame-tilte").html(str)
                $('.sjyDiv').hide();
                $('.operate').hide();
                $(".addsjyth").hide();
                $("#mouldName").val(data.modulename).attr({"readonly":"readonly"});
                $("#modulegroup").val(data.modulegroup).attr({"readonly":"readonly"}).hide();
                $("#modulegroupshow").val(data.modulegroup).attr({"readonly":"readonly"}).show();
                $("#mouldRemark").val(data.des).attr({"readonly":"readonly"});
                $('#lkrFrame .lkr-button').hide();
                window.bigData.editmoduleId = data.id
                let thStr=``
                data.modulefields.map(item => {
                    thStr += `<tr id="${item.id}" moduleid="${item.moduleid}">
                    <td class="columnComment">${item.fieldname?item.fieldname:''}</td>
                    <td class="columnName">${item.englishname?item.englishname:''}</td>
                    <td class="columnType">${item.fieldtype?item.fieldtype:''}</td> 
                    <td class="tableName">${item.tablename?item.tablename:''}</td>
                    <td class="columnRemark">${item.remark?item.remark:''}</td>
                    </tr>`
                })
                $('#addMb tbody').html(thStr)

            }
        })
    })
    function addModule(){
        window.bigData.frameType = 'add'
        let str =`新建模型
            <span style="cursor: pointer;" onclick='lkrFrameClose()'>x</span>`
        $(".lkr-frame-tilte").html(str)
        $('.sjyDiv').show();
        $('.operate').show();
        $('#fgiSource').show();
        $('.addsjyth').show();
        $("#mouldName").val("")
        $("#mouldRemark").val("")
        $("#addMb tbody").html("")
        $('#lkrFrame .lkr-button').show()
        $('#lkrFrame').show()
        $("#modulegroup").attr("readonly",false);
        $("#mouldName").attr("readonly",false);
        $("#mouldRemark").attr("readonly",false);
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type: "get",
            data: {type: 1},
            success(data){
                if(data.length == 0){
                    $('.noticeList').append(`<li>${parent.getTime()} 请先添加模型分组！</li>`)
                    parent.toastr.info('请先添加模型分组！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    return
                }
                $("#modulegroup").val("");
            }
        })
    }
    $("#fgiName").change((e)=>{
        $.ajax({
            url:urlConfig.host+'/module/findAllFiledByTableName',
            data:{
                tableName:$(e.target).val()
            },
            success: function(data) {
                window.bigData.mouldParam = data
                let thStr = ''
                data.map(item => {
                    thStr += `<tr><td><input id='${'chk'+item.COLUMN_NAME}' type="checkbox" name="item" data-id='${item.COLUMN_NAME}' onchange="showAll(event)"/></td>
                    <td>${item.COLUMN_COMMENT?item.COLUMN_COMMENT:''}</td>
                    <td>${item.COLUMN_NAME?item.COLUMN_NAME:''}</td>
                    <td>${item.COLUMN_TYPE?item.COLUMN_TYPE:''}</td>
                    <td><input type="text" value="" readonly="readonly"></td>
                    </tr>`
                })
                $('#addSource tbody').html(thStr)
                let isAllNum = 0
                window.bigData.editmoduledata.map(item => {
                    if($(e.target).val() ==item.tableName){
                        $('#chk'+item.fieldname).prop('checked',true)
                        isAllNum ++
                    }
                })
                if(isAllNum == data.length){
                    $("#selectAll").prop("checked",true)
                }
            }
        })
    })
    function showAll(e){
        let leg =0
        $("#addSource tbody tr").each((i,v) => {
            let items = $(v).children("td").find("input:checkbox")
            if( items.prop('checked')){
                leg ++
            }
        })
        if(leg == $("#addSource tbody tr").length){
            $("#selectAll").prop("checked",true)
        }else{
            $("#selectAll").prop("checked",false)
        }
    }
    $("#fgiSource").click((e) => {
        let addMbTr = $('#addMb tbody tr')
        window.bigData.editmoduledata =[]
        $("#selectAll").prop("checked",false)
        if(addMbTr.length > 0){
           $("#addMb tbody tr").each((i,v) => {
                let items = $(v)
                window.bigData.editmoduledata.push({
                    fieldname:(items.children('.columnName').text()).trim()?(items.children('.columnName').text()).trim():items.children('.columnName').find('input').val(),
                    tableName:(items.children('.tableName').text()).trim()?(items.children('.tableName').text()).trim() :items.children('.tableName').find('input').val()
                })
            })
        }
        $("#sourceName").fadeToggle(500)
        $.ajax({
            url:urlConfig.host+'/module/findAllTableFromDB',
            data:'',
            success: function(data) {
                let str = '<option>请选择</option>'
                data.map(item => {
                    str += `<option>${item}</option>`
                })
                $("#fgiName").html(str)
                // fgiNameChange()

            }
        })

    })

    function selectAll(selectStatus){//传入参数（全选框的选中状态）
        //根据name属性获取到单选框的input，使用each方法循环设置所有单选框的选中状态
        if(selectStatus){
            $("input[name='check']").each(function(i,n){
            n.checked = true;
            });
        }else{
            $("input[name='check']").each(function(i,n){
            n.checked = false;
            });
        }
    }
    /**
     * 关闭模型二次删除确认框
    */
    function lkrFrameDelClose(){
        $('#lkrFrameDel').hide()
    }
    /**
     * 关闭新建参数模型框
    */
    function lkrFrameClose(){
        reseAddMb()
        $("#modulegroup").show();
        $("#modulegroupshow").hide();
        $('#lkrFrame').hide()
    }
    function Confirm(){
        let mouldParam = []
        if($("#modulegroup").val() == ""){
            toastr.info('模型所属组不能为空！')
            $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
            return false;
        }
        var rName=$("#modulegroup").val();
        if(window.bigData.frameType == 'add'){
            let flag = true
            if($("#mouldName").val() == ""){
                $('.noticeList').append(`<li>${parent.getTime()} 请填写模型名称！ </li>`)
                    parent.toastr.info('请填写模型名称！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    flag = false
                    return false
            }
            $("#addMb tbody tr").each((i,v) => {
                let items = $(v)

                if((items.children('.columnComment').text()).trim() == "" && items.children('.columnComment').find('input').val() == ""){
                    $('.noticeList').append(`<li>${parent.getTime()} 请填写【模型】字段中文名称！ </li>`)
                    parent.toastr.info('请填写【模型】字段中文名称！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    flag = false
                    return false
                }
                if((items.children('.columnName').text()).trim() == "" && items.children('.columnName').find('input').val() == ""){
                    $('.noticeList').append(`<li>${parent.getTime()} 请填写【模型】字段英文名称！ </li>`)
                    parent.toastr.info('请填写【模型】字段英文名称！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    flag = false
                    return false
                }
                // if(items.children('.columnType').find('select').val() == ""){
                //     $('.noticeList').append(`<li>${getTime()}请选择字段类型！ </li>`)
                //     toastr.info('请选择字段类型！')
                //     $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                //     flag = false
                //     return false
                // }
                if((items.children('.tableName').text()).trim() == "" && items.children('.tableName').find('input').val() == ""){
                    $('.noticeList').append(`<li>${parent.getTime()} 请填写【模型】字段表名！ </li>`)
                    parent.toastr.info('请填写【模型】字段表名！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    flag = false
                    return false
                }
                mouldParam.push({
                    fieldname:(items.children('.columnComment').text()).trim()?(items.children('.columnComment').text()).trim():(items.children('.columnComment').find('input').val()).trim(),
                    fieldtype:items.find('.moduleInputOne').val()?items.find('.moduleInputOne').val():(items.children('.columnType').text()).trim(),
                    tablename:(items.children('.tableName').text()).trim()?(items.children('.tableName').text()).trim():(items.children('.tableName').find('input').val()).trim(),
                    englishname:(items.children('.columnName').text()).trim()?(items.children('.columnName').text()).trim():(items.children('.columnName').find('input').val()).trim(),
                    remark:(items.children('.columnRemark').text()).trim()?(items.children('.columnRemark').text()).trim():(items.children('.columnRemark').find('input').val()).trim(),
                })
            })
            let param = {
                modulegroup:$("#modulegroup").val(),
                modulename:$("#mouldName").val(),
                modulefields:mouldParam,
                des:$("#mouldRemark").val(),
                // sqlurl:null,
                remark:'',
                // id:null
            }
            if(flag){
                $.ajax({
                    url:urlConfig.host+'/module/addModule',
                    type:'post',
                    dataType: 'json',
                    data:JSON.stringify(param),
                    contentType: "application/json;charset=UTF-8",//指定消息请求类型
                    success: function(data) {
                        $(".moduleContentList").html('')
                        $('.noticeList').append(`<li>${parent.getTime()} 新增【模型】保存成功！ </li>`)
                        parent.toastr.success('新增【模型】保存成功！')
                        $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                        $.ajax({
                            url:urlConfig.host+'/module/GetAllModule',
                            data:'',
                            success: function(data) {
                                if(data){
                                    $("#modulegroup").val("")
                                    $("#mouldName").val("")
                                    $("#mouldRemark").val("")
                                    $('#addMb tbody').html('')
                                }
                            }
                        })
                        $.ajax({
                            url: urlConfig.host + '/module/GetModuleByGroupName',
                            type:"get",
                            data: {moduleGroupName:$("#modulegroup").val()},
                            success(data) {
                                $("#dataModulePage .mxGruopTable").empty();
                                if(data.length){
                                    $("#dataModulePage .mxGruopTable").append(`<thead>
                                    <th style="width: 150px">模型名称</th>
                                    <th style="width: 150px">描述</th>
                                    <th style="width: 150px">状态</th>
                                    <th style="width: 200px">操作</th>
                                    </thead>`)
                                    data.map(s=>{
                                        var img,title;
                                        if(s.status == "未发布"){
                                            img = "static/fabu.png";
                                            title = "发布";
                                        } else {
                                            img = "static/cancelFb.png";
                                            title = "取消发布";
                                        }
                                        $("#dataModulePage .mxGruopTable").append(
                                            `<tr>
                                    <td title="${s.modulename}" style="width: 150px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;">${s.modulename}</td>
                                    <td title="${s.des}" style="width: 150px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;">${s.des}</td>
                                    <td style="width: 150px">${s.status}</td>
                                    <td style="width: 150px">
                                        <img moduleId="${s.id}" class="lkr-list-edit" title="修改" src="static/edit.png" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer">
                                        <img moduleId="${s.id}" class="lkr-list-del" title="删除" src="static/delete.png" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer;margin: 0 10px">
                                        <img title="${title}" src="${img}" onclick="publishModule('${s.id}','${title}')" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer">
                                    </td>
                                </tr>
                            `)
                                    })
                                }
                                $.ajax({
                                    url: urlConfig.host + '/group/findAllGroupMessagesByType',
                                    type:"get",
                                    data: {type :1},
                                    success(data) {
                                        var treeData=[]
                                        data.map(s=>{
                                            treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":s.grouptype})
                                        })
                                        $.fn.zTree.init($("#modelWinTree"),setting, treeData);
                                        var zTreeObject = $.fn.zTree.getZTreeObj("modelWinTree");
                                        var node = zTreeObject.getNodeByParam('name',rName);
                                        zTreeObject.cancelSelectedNode();
                                        zTreeObject.selectNode(node, true);
                                    }
                                })
                                dataModlue()
                            }
                        })
                        $('#lkrFrame').fadeToggle(500)
                        $("#dataModulePage").show()
                    }
               }) 
            }
          
        }else{
            let flag = true

            $("#addMb tbody tr").each((i,v) => {
                let items = $(v)
                let id=0
                if(items.attr("id")){
                    id = items.attr("id")
                }
                if(items.children('.columnComment').find('input').val() == ""){
                    $('.noticeList').append(`<li>${parent.getTime()} 请填写【模型】字段中文名称！ </li>`)
                    parent.toastr.info('请填写【模型】字段中文名称！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    flag = false
                    return false
                }
                if(items.children('.columnName').find('input').val() == ""){
                    $('.noticeList').append(`<li>${parent.getTime()} 请填写【模型】字段英文名称！ </li>`)
                    parent.toastr.info('请填写【模型】字段英文名称！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    flag = false
                    return false
                }
                // var types;
                // if(items.children('.columnType').find('select').css("display") == "none"){
                //     types= items.children('.columnType').find('input').val()
                // } else {
                //     types = items.children('.columnType').find('select').val()
                // }
                mouldParam.push({
                    fieldname:items.children('.columnComment').find('input').val(),
                    fieldtype:items.find('.moduleInputOne').val()?items.find('.moduleInputOne').val():(items.children('.columnType').text()).trim(),
                    tablename:items.children('.tableName').find('input').val(),
                    englishname:items.children('.columnName').find('input').val(),
                    remark:items.children('.columnRemark').find('input').val(),
                    id:items.attr("id") || 0,
                    moduleid:items.attr("moduleid") || window.bigData.editmoduleId
                })
            })

            let param = {
                id:window.bigData.editmoduleId,
                modulegroup:$("#modulegroup").val(),
                modulename:$("#mouldName").val(),
                modulefields:mouldParam,
                des:$("#mouldRemark").val(),
                // sqlurl:null,
                remark:'',
            }
            if(flag){
                $.ajax({
                    url:urlConfig.host+'/module/modModuleById',
                    type:'post',
                    dataType: 'json',
                    data:JSON.stringify(param),
                    contentType: "application/json;charset=UTF-8",//指定消息请求类型
                    success: function(data) {
                        $(".moduleContentList").html('')
                        $('.noticeList').append(`<li>${parent.getTime()}【模型】修改成功！ </li>`)
                        parent.toastr.success('【模型】修改成功！')
                        $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                        $.ajax({
                            url:urlConfig.host+'/module/GetAllModule',
                            data:'',
                            success: function(data) {
                                $('#lkrFrame').fadeToggle(500)
                                $("#dataModulePage").show()
                                $.ajax({
                                    url: urlConfig.host + '/group/findAllGroupMessagesByType',
                                    type:"get",
                                    data: {type :1},
                                    success(data) {
                                        var treeData=[]
                                        data.map(s=>{
                                            treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":s.grouptype})
                                        })
                                        $.fn.zTree.init($("#modelWinTree"),setting, treeData);
                                        var zTreeObject = $.fn.zTree.getZTreeObj("modelWinTree");
                                        var node = zTreeObject.getNodeByParam('name',rName);
                                        zTreeObject.cancelSelectedNode();
                                        zTreeObject.selectNode(node, true);
                                        freshClick("modelWinTree")
                                        freshClick("moduleTree")
                                    }
                                })
                                dataModlue()
                            }
                        })
                    }
                })
            }
        }
    }
    function reseTabs(){
        $.ajax({
            url:urlConfig.host+'/module/GetModuleGroup',
            data:'',
            success: function(data) {
                $("#pic_list li a").each((i,v) => {
                    console.log($(v).html())
                })
            }
        })
    }
    function reseAddMb(){
        $('#addMb tbody').html('')
        $("#mouldName").val('')
        $("#modulegroup").val('')
        $("#mouldRemark").val('')
        $("#modulegroup").prop('disabled',false)
        $("input:checkbox[name='item']").each((i,v) => {
            $(v).prop('checked',false)
        })
    }
    function zdlxChange(s) {
        s.prev().val(s.val())
    }

    function addsjyth(){
        $(".dataSourceTbody").append(`<tr>
            <td class="columnComment"><input type="text" value="" maxlength="20"></td>
            <td class="columnName"><input type="text" value="" maxlength="20"></td>
            <td class="columnType" style="position:relative;width: 110px"><input type="text" class="moduleInputOne" value="" style="background-color: rgba(0,0,0,0);border: none;outline: none;background-image: url(./static/select.png);background-size: 100% 100%;background-repeat: no-repeat;height: 30px;position: absolute;left:5px;top: 5px;width: 70px">
                        <select class="moduleSelect" onchange="zdlxChange($(this))">
                            <option value="byte">byte</option>
                            <option value="short">short</option>
                            <option value="int">int</option>
                            <option value="long">long</option>
                            <option value="float">float</option>
                            <option value="double">double</option>
                            <option value="boolean">boolean</option>
                            <option value="char">char</option>
                            <option value="date">date</option>
                            <option value="string">string</option>
                            <option value="blob">blob</option>
                            <option value="array">array</option>
                        </select>
            </td>
            <td class="tableName"><input type="text" value="-"  maxlength="20"></td>
            <td class="columnRemark"><input type="text" value="" maxlength="500"></td>
            
            <td><img src="static/delete.png"   onclick="delTab(event)" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer"></td></tr>`)
    }
   
    function ConfirmDel(){
        $.ajax({
            url:urlConfig.host+'/module/delModuleById',
            data:{moduleId:window.bigData.delmoduleId},
            success: function(data) {
                if(data){
                    window.bigData.delmoduleId = ''
                    $('.noticeList').append(`<li>${parent.getTime()}【模型】删除成功！ </li>`)
                    parent.toastr.success('【模型】删除成功！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    $('#lkrFrameDel').hide()
                    freshClick("modelWinTree")
                    freshClick("moduleTree")
                }
            }
        })
    }
    function freshClick(treeId) {
        var tObj=$.fn.zTree.getZTreeObj(treeId);
        var selectedNode=tObj.getSelectedNodes()[0];
        if(selectedNode){
            $("#"+selectedNode.tId+"_a").click();
        }
    }

    //树节点点击
    function treeClick(event, treeId, node) {
        if(node.type == "end"){
            if(node.pid == 0){
                $("#parentGroup").val("")
            } else {
                $.ajax({
                    url: urlConfig.host + '/group/findAllGroupMessagesByType',
                    type:"get",
                    data: {type:$("#groupInputName").attr("types")},
                    success(data) {
                        data.map(s=>{
                            if(s.id == node.pid){
                                $("#parentGroup").val(s.groupname)
                            }
                        })
                    }
                })
            }
            parent.$("#moduleGroupDeleteYes").attr("deleteid",node.id)
            parent.$("#parentGroup").attr("parentid",node.pid)
            parent.$("#groupInputName").attr("modifyId",node.id)
            parent.$("#groupInputName").val(node.name)
            return
        }
        var allName = []
        allName.push(node.name)
        function names(parent) {
            if(parent.children){
                parent.children.map(s=>{
                    allName.push(s.name);
                    names(s)
                })
            }
        }
        names(node)
        if($("#searchName").val()){
            var value = $("#searchName").val()
        }
        if(node.type == 1){
            if(node.right == 1){
                $("#moduleListRight").empty()
                allName.map(name=>{
                    $.ajax({
                        url: urlConfig.host + '/module/GetModuleByGroupName',
                        type:"get",
                        data: {moduleGroupName:name},
                        success(data) {
                            if(data.length){
                                data.map((s,index)=>{
                                    if(s.modulename.includes(value)){
                                        $("#moduleListRight").append(`<div class="left-list"><div title="${s.modulename}" moduleId="${s.id}" class="left-list-tilte dbclickModule red" style="height:50px;">${s.modulename}</div></div>`)
                                    } else {
                                        $("#moduleListRight").append(`<div class="left-list"><div title="${s.modulename}" moduleId="${s.id}" class="left-list-tilte dbclickModule" style="height:50px;">${s.modulename}</div></div>`)
                                    }
                                })
                            }
                        }
                    })
                })
            } else {
                $("#dataModulePage .mxGruopTable").empty();
                allName.map(name=>{
                    $.ajax({
                        url: urlConfig.host + '/module/GetModuleByGroupName',
                        type:"get",
                        data: {moduleGroupName:name},
                        success(data) {
                            if(data.length){
                                if(!$("#dataModulePage .mxGruopTable thead").length){
                                    $("#dataModulePage .mxGruopTable").append(`<thead>
                                        <th style="width: 150px">模型名称</th>
                                        <th style="width: 150px">描述</th>
                                        <th style="width: 150px">状态</th>
                                        <th style="width: 200px">操作</th>
                                        </thead>`)
                                }
                                data.map(s=>{
                                    var img,title;
                                    if(s.status == "未发布"){
                                        img = "static/fabu.png";
                                        title = "发布";
                                    } else {
                                        img = "static/cancelFb.png";
                                        title = "取消发布";
                                    }
                                    $("#dataModulePage .mxGruopTable").append(
                                        `<tr>
                                        <td title="${s.modulename}" style="width: 150px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;">${s.modulename}</td>
                                        <td title="${s.des}" style="width: 150px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;">${s.des}</td>
                                        <td style="width: 150px">${s.status}</td>
                                        <td style="width: 150px">
                                            <img moduleId="${s.id}" class="lkr-list-edit" title="修改" src="static/edit.png" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer">
                                            <img moduleId="${s.id}" class="lkr-list-del" title="删除" src="static/delete.png" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer;margin: 0 10px">
                                            <img title="${title}" src="${img}" onclick="publishModule('${s.id}','${title}')" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer">
                                        </td>
                                    </tr>
                                   `)
                                })
                            }
                        }
                    })
                })
            }
        }
        if(node.type == 2){
            if(node.right == 2){
                $("#sfGruopListRight").empty();
                allName.map(name=>{
                    $.ajax({
                        url: urlConfig.host + '/operatorMaintenance/getAllAlgorithm',
                        type:"get",
                        data: {groupName :name},
                        success(data) {
                            if(data.length){
                                data.map((s,index)=>{
                                    window.addAlgorithm({
                                        name: 'rectangle',
                                        icon: 'icon-rectangle',
                                        id:s.tableAlgorithm.id,
                                        type:"tableAlgorithm",
                                        data: {
                                            id:s.tableAlgorithm.id,
                                            text: s.tableAlgorithm.algorithmname,
                                            rect: {
                                                width: 200,
                                                height: 100
                                            },
                                            parentId:s.tableAlgorithm.id,
                                            font: {
                                                fontFamily: 'Arial',
                                                color: 'aqua',
                                                textBaseline: 'top'
                                            },
                                            data:{
                                                inNum:s.inNum,
                                                outNum:s.outNum,
                                                index:index,
                                                sid:s.tableAlgorithm.id
                                            },
                                            children:[],
                                            paddingLeft: 10,
                                            paddingRight: 10,
                                            paddingTop: 10,
                                            paddingBottom: 10,
                                            borderRadius: 0.1,
                                            name: 'rectangle',
                                            fillStyle:'rgba(4,44,98,0.58)',
                                            strokeStyle: '#4295ec',
                                            hideInput:true
                                        }
                                    })
                                })
                                $("#sfGruopListRight .left-list-tilte").removeClass("red");
                                $("#sfGruopListRight .left-list-tilte").each((i,s)=>{
                                    if($(s).text().includes(value)){
                                        $(s).addClass("red")
                                    }
                                })
                            }
                        }
                    })
                })
            } else {
                $("#dicDiv .sfGruopTable").empty()
                allName.map(name=>{
                    $.ajax({
                        url: urlConfig.host + '/operatorMaintenance/getAllAlgorithm',
                        type:"get",
                        data: {groupName:name},
                        success(data) {
                            if(data.length){
                                if(!$("#dicDiv .sfGruopTable thead").length){
                                    $("#dicDiv .sfGruopTable").append(`<thead>
                                    <th style="width: 120px">作者</th>
                                    <th style="width: 120px">算法名称</th>
                                    <th style="width: 120px">算法描述</th>
                                    <th style="width: 120px">状态</th>
                                    <th style="width: 150px">操作</th>
                                    </thead>`)
                                }
                                data.map(s=>{
                                    var img,title;
                                    if(s.tableAlgorithm.status == "未发布"){
                                        img = "static/fabu.png";
                                        title = "发布";
                                    } else {
                                        img = "static/cancelFb.png";
                                        title = "取消发布";
                                    }
                                    $("#dicDiv .sfGruopTable").append(
                                        `<tr class="dbclickAlgorithm" algorithmid="${s.tableAlgorithm.id}">
                            <td title="${s.tableAlgorithm.algorithmauthor}" style="width: 150px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;" algorithmid="${s.tableAlgorithm.id}">${s.tableAlgorithm.algorithmauthor}</td>
                            <td title="${s.tableAlgorithm.algorithmname}" style="width: 150px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;" algorithmid="${s.tableAlgorithm.id}">${s.tableAlgorithm.algorithmname}</td>
                            <td title="${s.tableAlgorithm.des}" style="width: 150px;overflow: hidden;text-overflow:ellipsis;white-space: nowrap;" algorithmid="${s.tableAlgorithm.id}">${s.tableAlgorithm.des}</td>
                            <td style="width: 150px" algorithmid="${s.tableAlgorithm.id}">${s.tableAlgorithm.status}</td>
                            <td style="width: 150px" algorithmid="${s.tableAlgorithm.id}">
                                <img title="修改" src="static/edit.png" onclick="editZd(${s.tableAlgorithm.id})" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer">
                                <img title="删除" src="static/delete.png" onclick="deleteZd(${s.tableAlgorithm.id})" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer;margin: 0 10px">
                                <img title="${title}" src="${img}" onclick="publishSf('${s.tableAlgorithm.id}','${title}')" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer">
                            </td>
                        </tr>
                       `)
                                })
                            }
                        }
                    })
                })
            }
        }
        if(node.type == 3){
            if(node.right == 3){
                $("#ruleListRight").empty()
                allName.map(name=>{
                    $.ajax({
                        url: urlConfig.host + '/algorithmRule/getAllAlgorithmRule',
                        type:"get",
                        data: {groupName:name},
                        success(data) {
                            if(data.length){
                                data.map((s,index)=>{
                                    if (s.rolename.includes(value)){
                                        $("#ruleListRight").append(`<div class="left-list"><div title="${s.rolename}" ruleId="${s.id}" class="left-list-tilte lkr-list-ediRule red" style="height:50px;">${s.rolename}</div></div>`)
                                    } else {
                                        $("#ruleListRight").append(`<div class="left-list"><div title="${s.rolename}" ruleId="${s.id}" class="left-list-tilte lkr-list-ediRule" style="height:50px;">${s.rolename}</div></div>`)
                                    }
                                })
                            }
                        }
                    })
                })
            } else {
                $("#gzDiv .gzGruopTable").empty()
                allName.map(name=>{
                    $.ajax({
                        url: urlConfig.host + '/algorithmRule/getAllAlgorithmRule',
                        type:"get",
                        data: {groupName:name},
                        success(data) {
                            if(data.length){
                                if(!$("#gzDiv .gzGruopTable thead").length){
                                    $("#gzDiv .gzGruopTable").append(`<thead>
                                        <th style="width: 150px">规则名称</th>
                                        <th style="width: 150px">描述</th>
                                        <th style="width: 150px">状态</th>
                                        <th style="width: 180px">操作</th>
                                        </thead>`)
                                }
                                data.map(s=>{
                                    var img,title;
                                    if(s.status == "未发布"){
                                        img = "static/fabu.png";
                                        title = "发布";
                                    } else {
                                        img = "static/cancelFb.png";
                                        title = "取消发布";
                                    }
                                    $("#gzDiv .gzGruopTable").append(
                                        `<tr>
                            <td title="${s.rolename}" style="width: 150px;overflow: hidden;text-overflow: ellipsis;white-space: nowrap">${s.rolename}</td>
                            <td title="${s.des}" style="width: 150px;overflow: hidden;text-overflow: ellipsis;white-space: nowrap">${s.des}</td>
                            <td style="width: 150px">${s.status}</td>
                            <td style="width: 180px">
                                <img class="lkr-list-ediRule" ruleId="${s.id}" title="修改" src="static/edit.png" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer">
                                <img onclick="deleteRuleById(${s.id})" title="删除" src="static/delete.png" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer;margin: 0 10px">
                                <img title="${title}" src="${img}" onclick="publishRule('${s.id}','${title}')" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer;margin-right: 10px">
                                <img title="导出" src="static/download.png" onclick="downloadRule(${s.id})" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer">
                            </td>
                        </tr>
                       `)
                                })
                            }
                        }
                    })
                })
            }
        }
        if(node.type == "win"){
            $("#parentGroup").val(node.name);
            $("#parentGroup").attr("parentid",node.id);
            $("#groupTreeDiv").hide()
        }
        if(node.type == "groupMx"){
            $("#modulegroup").val(node.name)
            $("#groupTreeDiv").hide()
        }
        if(node.type == "groupSf"){
            $("#group").val(node.name)
            $("#groupTreeDiv").hide()
        }
        if(node.type == "groupGs"){
            $("#groupGs").val(node.name)
            $("#groupTreeDiv").hide()
        }
        if(node.type == "groupGz"){
            $("#gzGroupName").val(node.name)
            $("#groupTreeDiv").hide()
        }
    }
    function dataModlue(){
        $("#moduleListRight").empty();
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type:1},
            success(data) {
                mxDataAll = {};
                var treeData=[]
                data.map(s=>{
                    treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":s.grouptype,"right":s.grouptype})
                    $.ajax({
                        url: urlConfig.host + '/module/GetModuleByGroupName',
                        type:"get",
                        data: {moduleGroupName:s.groupname},
                        success(data) {
                            if(data.length){
                                var datas = [];
                                data.map(t=>{
                                    datas.push(t.modulename)
                                })
                                mxDataAll[s.groupname] = datas;
                            }
                        }
                    })
                })
                $.fn.zTree.init($("#moduleTree"),setting, treeData);
            }
        })
        $("#modelPageDiv").show();
        $("#ruleMde").hide();
        $("#algorithmPage").hide();
    }
    function ModuleClose(){
        $('#dataModulePage').hide()
    }
    function editAlgorithm(){
        sessionStorage.src="";
        sessionStorage.latex="";
        try {
            ue.setContent('');
        }catch (e) {
            console.log(e);
        }
        
        $(".Frame").fadeToggle(500);
        $("#dicDiv").hide()
        $(".gsTitle").text("公式编辑")
        $("#companyGs").attr("disabled",false)
        $("#groupGs").attr("disabled",false)
        AlgorithmConfirm()
        window.bigData.formulaType = 'add';
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type:2},
            success(data){
                if(data.length == 0){
                    $('.noticeList').append(`<li>${parent.getTime()} 请先添加【算法】分组！</li>`)
                    parent.toastr.info('请先添加【算法】分组！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    return
                }
                $("#group").val("");
                $("#groupGs").val("");
            }
        })
        
    }
    function AlgorithmClose(){
        $('#AddAlgorithm').fadeToggle(500)
    }
    function sourceNameClose(){
        $('#addSource tbody').html('')
        $("#sourceName").fadeToggle(500)
    }
    function sourceNameConfirm(){
        let modlueList =[]
        $("input:checkbox[name='item']").each((i,v) => {
            let items = $(v)
            let flag =true
            let list = $(items).parent().nextAll()
            if(items.prop('checked') && items.attr('id') != "selectAll"){            
               let addMbTr = $('#addMb tbody tr')
               if(addMbTr.length > 0){
                    for(let s=0;s<addMbTr.length;s++){
                        let itemh = $(addMbTr).eq(s)
                        let fieldname =(itemh.children('.columnName').text()).trim()?(itemh.children('.columnName').text()).trim():itemh.children('.columnName').find('input').val()
                        let tableName =(itemh.children('.tableName').text()).trim()?(itemh.children('.tableName').text()).trim():itemh.children('.tableName').find('input').val()
                        if( list.eq(1).text() == fieldname && $("#fgiName").val() == tableName){
                            flag = false
                            break;
                        }
                    }
                }
                if(flag){
                    let obj ={
                        COLUMN_NAME:list.eq(1).text(),
                        COLUMN_TYPE:list.eq(2).text(),
                        COLUMN_COMMENT:list.eq(0).text(),
                        TABLE_NAME:$("#fgiName").val()
                    }
                    modlueList.push(obj)
                }
            }else{
                let addMbTr = $('#addMb tbody tr')
                if(addMbTr.length > 0){
                    for(let s=0;s<addMbTr.length;s++){
                        let itemh = $(addMbTr).eq(s)
                        let fieldname =(itemh.children('.columnName').text()).trim()?(itemh.children('.columnName').text()).trim():itemh.children('.columnName').find('input').val()
                        let tableName =(itemh.children('.tableName').text()).trim()?(itemh.children('.tableName').text()).trim():itemh.children('.tableName').find('input').val()
                        if( list.eq(1).text() == fieldname && $("#fgiName").val() == tableName){
                            $(addMbTr).eq(s).remove();
                        }
                    }
                }
                if( window.bigData.editmoduledata.length > 0){
                    window.bigData.editmoduledata.map((item,i)=>{
                        if((list.eq(1).text()).trim() == item.fieldname && ($("#fgiName").val()).trim() == item.tableName){
                            window.bigData.editmoduledata.splice(i,1)
                        }
                    })
                }
               
            }
        })
        
        let thStr = ''
        if(window.bigData.frameType == 'add'){
            modlueList.map(item => {
                thStr += `<tr>
                <td class="columnComment">${item.COLUMN_COMMENT?item.COLUMN_COMMENT:''}</td>
                <td class="columnName">${item.COLUMN_NAME?item.COLUMN_NAME:''}</td>
                <td class="columnType">${item.COLUMN_TYPE?item.COLUMN_TYPE:''}</td>
                <td class="tableName">${item.TABLE_NAME?item.TABLE_NAME:''}</td>
                <td class="columnRemark"><input type="text" value=""></td>
                <td><img src="static/delete.png"  onclick="delTab(event)" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer"></td></tr>`
            })
        }else{
            modlueList.map(item => {
                thStr += `<tr>
                <td class="columnComment"> <input type="text" value="${item.COLUMN_COMMENT?item.COLUMN_COMMENT:''}"></td>
                <td class="columnName"> <input type="text" value="${item.COLUMN_NAME?item.COLUMN_NAME:''}"></td>
                <td class="columnType"><select class="moduleSelect">
                            <option value="byte">byte</option>
                            <option value="short">short</option>
                            <option value="int">int</option>
                            <option value="long">long</option>
                            <option value="float">float</option>
                            <option value="double">double</option>
                            <option value="boolean">boolean</option>
                            <option value="char">char</option>
                            <option value="date">date</option>
                            <option value="string">string</option>
                            <option value="blob">blob</option>
                            <option value="array">array</option>
                        </select>
                       <input type="text"  class="moduleInputOne"  value="${item.COLUMN_TYPE?item.COLUMN_TYPE:''}" onchange="myFunction(event)"></td>
                <td class="tableName"> <input type="text" value="${item.TABLE_NAME?item.TABLE_NAME:''}"></td>
                <td class="columnRemark"><input type="text" value=""></td>
                <td><img src="static/delete.png"  onclick="delTab(event)" style="width: 24px;height: 24px;color: #fff;background: #0d1c4b;cursor: pointer"></td></tr>`
            })
        }
 
        $('#addMb tbody').append(thStr)
        $('#addSource tbody').html('')
        $("#sourceName").fadeToggle(500)
        $(".moduleSelect").change((e)=>{
            $(e.target).parent('.columnType').children('.moduleSelect').hide()
            $(e.target).parent('.columnType').children('.moduleInputOne').show()
            $(e.target).parent('.columnType').children('.moduleInputOne').val($(e.target).val())  
        })
    }


    function delTab(event){

        if( window.bigData.editmoduledata.length > 0){
            window.bigData.editmoduledata.map((item,i)=>{
                if(($(event.target).parents('tr').children(".columnName").text()).trim() == item.fieldname && ($(event.target).parents('tr').children(".tableName").text()).trim()  == item.tableName){
                    window.bigData.editmoduledata.splice(i,1)
                }
            })
        }
        $(event.target).parents('tr').remove();
    }
    function AlgorithmConfirm(){
        let s = $('#sfType').val();
        $("#AddAlgorithm").hide();
        $(".Frame").hide();
        $(".Logic").hide();
        if(s == "算法公式"){
            $(".Frame").show();
            window.bigData.formulaType = 'add';
            $("#gsName").val("");
            $("#gsDes").val("");
            $("#AlgorithmnameY").val("");
            $("#MathInput").val("");
            $(".MathJaxEdit").empty();
            $("#companyGs").val("")
            $("#gsName").attr("disabled",false);
            $("#gsDes").attr("disabled",false);
            $('#AlgorithmnameY').attr("disabled",false);
            $('#MathInput').attr("disabled",false);
            $('#MathInput').attr("disabled",false);
            $('.closeGsButton').show();
            $('#MathPreview').empty()
            $('#MathBuffer').empty()
        } else if(s == "逻辑运算"){
            $(".Logic").show();
            $('.closeLjButton').show();
            $('.LogicContent .addButton').show();
            $("#ljName").val("");
            $("#ljDes").val("");;
            $('#LogicName').val("");;
            $("#ljName").attr("disabled",false);
            $("#ljDes").attr("disabled",false);
            $('#LogicName').attr("disabled",false);
            $('.logicUl').empty();
            $(".logicUl").append(`
               <li class="logicLi">
                    <select name="" class="Logic-form-field inputButton">
                        <option value="">请选择字段</option>
                    </select>
                    <select name="" class="Logic-form-label inputButton">
                        <option value="">与</option>
                        <option value="">或</option>
                        <option value="">非</option>
                        <option value="">&lt; </option>
                        <option value="">&lt;=</option>
                        <option value="">&gt; </option>
                        <option value="">&gt;=</option>
                        <option value="">=</option>
                    </select>
                    <!-- <select name="" class="Logic-form-value inputButton">
                        <option value="">请选择取值</option>
                    </select>  -->
                    <input type="text" class="Logic-form-value inputButton">
                    <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                </li>
            `)
        }
    }
    function dictionary(){
        dictionaryShow()
    }
    //模型列表刷新
    function getModuleList(){
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type :1},
            success(data) {
                var treeData=[]
                data.map(s=>{
                    treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":s.grouptype})
                })
                $.fn.zTree.init($("#modelWinTree"),setting, treeData);
            }
        })
    }
    //算法库维护
    function dictionaryShow(){
        $("#modelPageDiv").hide();
        $("#ruleMde").hide();
        $("#algorithmPage").show();
        $("#sfGruopListRight").empty()
        $(".dataManage").text("算法管理")
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type:2},
            success(data) {
                sfDataAll = {};
                var treeData=[]
                data.map(s=>{
                    treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":s.grouptype,"right":s.grouptype})
                    $.ajax({
                        url: urlConfig.host + '/operatorMaintenance/getAllAlgorithm',
                        type:"get",
                        data: {groupName:s.groupname},
                        success(data) {
                            if(data.length){
                                var datas = [];
                                data.map(t=>{
                                    datas.push(t.tableAlgorithm.algorithmname)
                                })
                                sfDataAll[s.groupname] = datas;
                            }
                        }
                    })
                })
                $.fn.zTree.init($("#sfTree"),setting, treeData);
            }
        })
    }

    //删除字典信息
    function deleteZd(s) {
        $("#deleteZdButton").attr("deleteId",s)
        $('#deleteZdDiv').fadeToggle(500)
    }

    //修改字典信息
    function editZd(s) {
        $("#editDicYes").attr("editId",s)
        $("#group").attr("disabled",false)
        $("#editDicTitle").text("修改算法")
        $("#dicDiv").show()
        $("#companyGs").attr("disabled",false)
        $("#groupGs").attr("disabled",false)
        $.ajax({
            url:urlConfig.host +"/operatorMaintenance/getAlgorithmById",
            data:{algthId:s} ,
            type:"get",
            success(data) {
                if(data.tableAlgorithm.algorithmtype == 1){
                    $("#group").val("");
                    $("#group").val(data.tableAlgorithm.algorithmgroup)
                    $("#editDicYes").show();
                    $("#editDicName").val("");
                    $("#editDicDes").val("");
                    $("#editAuthor").val("")
                    $("#editAuthor").attr("disabled",false);
                    $("#editDicName").attr("disabled",false);
                    $("#editDicDes").attr("disabled",false);
                    $("#editDicName").val(data.tableAlgorithm.algorithmname);
                    $("#editDicDes").val(data.tableAlgorithm.des);
                    $("#editAuthor").val(data.tableAlgorithm.algorithmauthor)
                    $("#company").val("");
                    $("#company").val(data.tableAlgorithm.remark);
                    $("#zdStatus").val("");
                    $("#zdStatus").val(data.tableAlgorithm.status);
                    $("#zdcsList").empty();
                    $("#addZdcs").show();
                    $("#editDic").show();
                    data.tableFuncs.map(t=>{
                        $("#zdcsList").append(`
                         <div divId="${t.id}" class="zdcsDiv " style="margin-bottom: 15px">
                            <i style="margin-top: 5px">
                                <span style="color:#fff;">中文名</span>
                                <input class="zdcsCsmc" type="text" value="${t.parametername}" maxlength="50">
                            </i>
                            <i>
                                <span style="color:#fff;">英文名</span>
                                <input class="variable" type="text" value="${t.varname}" maxlength="20">
                            </i>
                            <i>
                                <span style="color:#fff;">类型</span>
                                <select class="zdcsSelect" onchange="changeVarType(event)">
                                    <option value="2">常量</option>
                                    <option value="3">模型</option>
                                    <option value="1">基本类型</option>
                                </select>
                            </i>
                            <i>
                                <span style="color:#fff;">取值</span>
                                <input type="text" value="" class="zdcsText" maxlength="20">
                            </i>
                            <i>
                                <span style="color:#fff;">输入输出</span>
                                <select class="zdcsExport">
                                    <option value="0">输入</option>
                                    <option value="1">输出</option>
                                </select>
                            </i>
                            <button class="deleteZdcs" style="float: right;margin-right:5px;background: #f56c6c;border: none;color: #fff;height: 30px;line-height: 30px">删除</button>
                        </div>
                    `)
                    })
                    for(var i=0;i<data.tableFuncs.length;i++){
                        $("#editDic .zdcsSelect").eq(i).val(data.tableFuncs[i].vartype)
                        $("#editDic .zdcsExport").eq(i).val(data.tableFuncs[i].inorout)
                        if(data.tableFuncs[i].vartype == 2){
                            $("#editDic .zdcsText").eq(i).val(data.tableFuncs[i].valvalue)
                        } else if(data.tableFuncs[i].vartype == 3){
                            var select = modelSelectList;
                            $("#editDic .zdcsText").eq(i).hide();
                            $(select).val(data.tableFuncs[i].valvalue);
                            $("#editDic .zdcsSelect").eq(i).parent().next().find("span").text("模型名称")
                            $("#editDic .zdcsSelect").eq(i).parent().next().append(select);
                            $("#editDic .zdcsSelect").eq(i).parent().next().find("select").val(data.tableFuncs[i].valvalue)
                        } else {
                            $("#editDic .zdcsText").eq(i).hide();
                            let select= $(`
                            <select class="zdcsTypeSelect">
                                <option>int</option>
                                <option>long</option>
                                <option>byte</option>
                                <option>short</option>
                                <option>float</option>
                                <option>double</option>
                                <option>boolean</option>
                                <option>number</option>
                                <option>char</option>
                                <option>date</option>
                                <option>string</option>
                                <option>blob</option>
                                <option>array</option>
                            </select>`)
                            select.val(data.tableFuncs[i].valvalue)
                            $("#editDic .zdcsSelect").eq(i).parent().next().find("span").text("数据项")
                            $("#editDic .zdcsSelect").eq(i).parent().next().append(select)
                        }
                    }
                } else if(data.tableAlgorithm.algorithmtype == 2){
                    $("#updateSzId").val(s);
                    $("#dicDiv").show();
                    $("#groupGs").val("")
                    $("#groupGs").val(data.tableAlgorithm.algorithmgroup)
                    $(".gsTitle").text("公式编辑")
                    sessionStorage.src=data.tableAlgorithm.remark2;
                    sessionStorage.latex="";
                    try{
                        ue.setContent('');
                        ue.execCommand('inserthtml', `<img class="kfformula" src=${data.tableAlgorithm.remark2} data-latex=${data.tableAlgorithm.algorithmfun}/>`);
                    }catch (e) {
                        console.log(e);
                    }
                    $("#gsStatus").val("");
                    $("#gsStatus").val(data.tableAlgorithm.status);
                    $("#companyGs").val("");
                    $("#companyGs").val(data.tableAlgorithm.remark);
                    $("#MathInput").val("");
                    $("#gsName").attr("disabled",false);
                    $("#gsDes").attr("disabled",false);
                    $('#AlgorithmnameY').attr("disabled",false);
                    $('#MathInput').attr("disabled",false);
                    $("#MathInput").val(data.tableAlgorithm.algorithmfun);
                    $("#MathInput").attr("disabled",false)
                    $('.closeGsButton').show();
                    $("#gsName").val("");
                    $("#gsDes").val("");
                    $('#AlgorithmnameY').val("");
                    $("#gsName").val(data.tableAlgorithm.algorithmauthor);
                    $("#gsDes").val(data.tableAlgorithm.des);
                    $('#AlgorithmnameY').val(data.tableAlgorithm.algorithmname)
                    $('#AlgorithmnameY').attr({"value":data.tableAlgorithm.algorithmname,"tableAlgorithmid":data.tableAlgorithm.id,"tableAlmoduleid":data.tableAlgorithm.moduleid});
                    window.bigData.editFormula = data.tableAlgorithm.algorithmfun;

                    window.bigData.formulaType = 'edit';
                    if(data.tableFuncs.length>0){
                        let str =``
                        data.tableFuncs.map((item)=>{
                            str +=`<div class="MathJaxParam" formulaid="${item.id}" formulaModuleId="${item.algorithmid}" inorout="${item.inorout}">
                                        <div class="width-50">
                                            <span>中文名</span>
                                            <input type="text" value="${item.parametername}" class="MathJaxInputCs inputButton" maxlength="50">
                                        </div>
                                        <div class="width-50">
                                            <span>英文</span>
                                            <input type="text" readonly="readonly" value="${item.varname}" class="MathJaxInput1 inputButton" maxlength="20">
                                        </div>
                                        <div class="width-50 width-select">
                                            <span>类型</span>
                                            <select  class="MathJaxInput2 inputButton">
                                                <option value="2">常量</option>
                                                <option value="1">基本类型</option>
                                            </select>
                                        </div>
                                        <div class="width-50 isShow1">
                                                <span>取值</span >
                                                <input type="text" class="MathJaxInput3 inputButton" maxlength="20">
                                        </div>
                                        <div class="width-50 isShow2">
                                            <span>基本类型</span>
                                            <select class="MathJaxSelect  MathJaxInput1 inputButton">
                                                <option>byte</option>
                                                <option>short</option>
                                                <option>int</option>
                                                <option>long</option>
                                                <option>float</option>
                                                <option>double</option>
                                                <option>boolean</option>
                                                <option>char</option>
                                                <option>date</option>
                                                <option>string</option>
                                                <option>blob</option>
                                                <option>array</option>
                                            </select>
                                        </div>
                                        <div class="width-50">
                                                <span>描述</span>
                                                <input type="text" class="MathJaxInput4 inputButton" value="${item.remark}" maxlength="500">
                                        </div>
                                    </div>`
                        })
                        $(".MathJaxEdit").html(str)
                        for(let j=0;j<data.tableFuncs.length;j++){
                            for(k=0;k<$('.MathJaxParam').length;k++){
                                let vType = data.tableFuncs[j].vartype
                                if(j == k){
                                    $('.MathJaxParam').eq(k).find(".MathJaxInput2").find("option[value='"+vType+"']").attr("selected",true);
                                    if(vType == "2"){
                                        $('.MathJaxParam').eq(k).find('.isShow2').attr("style","display:none;");
                                        $('.MathJaxParam').eq(k).find(".isShow1").attr("style","display:block;");
                                        $('.MathJaxParam').eq(k).find(".isShow1").find('input').attr("value",data.tableFuncs[j].valvalue)
                                    }
                                    if(vType == "1"){
                                        $('.MathJaxParam').eq(k).find('.isShow1').attr("style","display:none;");
                                        $('.MathJaxParam').eq(k).find(".isShow2").attr("style","display:block;");
                                        $('.MathJaxParam').eq(k).find(".isShow2").find('input').attr("value",data.tableFuncs[j].valvalue)
                                        $('.MathJaxParam').eq(k).find(".MathJaxSelect").val(data.tableFuncs[j].valvalue)
                                    }
                                }
                            }
                        }
                    }
                    $('.Frame').fadeToggle(500)
                } else if(data.tableAlgorithm.algorithmtype == 3){
                    window.bigData.formulaType = 'edit';
                    $('.closeLjButton').show();
                    $('#LogicName').attr({"value":data.tableAlgorithm.algorithmname,"tableAlgorithmid":data.tableAlgorithm.id,"tableAlmoduleid":data.tableAlgorithm.moduleid});
                    $("#ljName").val(data.tableAlgorithm.algorithmauthor);
                    $('#ljDes').val(data.tableAlgorithm.des);
                    let algorithmfun = data.tableAlgorithm.algorithmfun;
                    $.ajax({
                        url:urlConfig.host+'/module/getModuleColumns',
                        data:{moduleId:window.bigData.formulaModuleId},
                        success: function(data) {
                            let str1 =``
                            if(data.length>0){
                                data.map(item => {
                                    str1 += `<option value="${item.fieldname}">${item.fieldname}</option>`
                                })
                                $('.Logic-form-field').html(str1)
                            }
                            let obj;
                            algorithmfun = algorithmfun.split(" and ")
                            let str =``
                            for(let i=0;i<algorithmfun.length;i++){
                                if(algorithmfun[i].indexOf('与') !=-1){
                                     obj = algorithmfun[i].split("与")
                                    str+=` <li class="logicLi">
                                                <select name="" class="Logic-form-field inputButton">
                                                    <option value="">${obj[0]}</option>
                                                </select>
                                                <select name="" class="Logic-form-label inputButton">
                                                    <option value="" selected>与</option>
                                                    <option value="">或</option>
                                                    <option value="">非</option>
                                                    <option value="">&lt;</option>
                                                    <option value="">&lt;=</option>
                                                    <option value="">&gt;</option>
                                                    <option value="">&gt;=</option>
                                                    <option value="">=</option>
                                                </select>
                                                <!-- <select name="" class="Logic-form-value inputButton">
                                                    <option value="">请选择取值</option>
                                                </select>  -->
                                                <input type="text" class="Logic-form-value inputButton" value="${obj[1]}">
                                                <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                                            </li>`
                                    $('.logicLi').eq(i).find(".Logic-form-field").find("option[value='"+obj[0]+"']").attr("selected",true);
                                }
                                if(algorithmfun[i].indexOf('或') !=-1){
                                     obj = algorithmfun[i].split("或")
                                    str+=` <li class="logicLi">
                                                <select name="" class="Logic-form-field inputButton">
                                                    <option value="">${obj[0]}</option>
                                                </select>
                                                <select name="" class="Logic-form-label inputButton">
                                                    <option value="">与</option>
                                                    <option value="" selected>或</option>
                                                    <option value="">非</option>
                                                    <option value="">&lt;</option>
                                                    <option value="">&lt;=</option>
                                                    <option value="">&gt;</option>
                                                    <option value="">&gt;=</option>
                                                    <option value="">=</option>
                                                </select>
                                                <!-- <select name="" class="Logic-form-value inputButton">
                                                    <option value="">请选择取值</option>
                                                </select>  -->
                                                <input type="text" class="Logic-form-value inputButton" value="${obj[1]}">
                                                <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                                            </li>`
                                    $('.logicLi').eq(i).find(".Logic-form-field").find("option[value='"+obj[0]+"']").attr("selected",true);
                                }
                                if(algorithmfun[i].indexOf('非') !=-1){
                                     obj = algorithmfun[i].split("非")
                                    str+=` <li class="logicLi">
                                            <select name="" class="Logic-form-field inputButton">
                                                <option value="">${obj[0]}</option>
                                            </select>
                                            <select name="" class="Logic-form-label inputButton">
                                                <option value="">与</option>
                                                <option value="">或</option>
                                                <option value="" selected>非</option>
                                                <option value="">&lt;</option>
                                                <option value="">&lt;=</option>
                                                <option value="">&gt;</option>
                                                <option value="">&gt;=</option>
                                                <option value="">=</option>
                                            </select>
                                            <!-- <select name="" class="Logic-form-value inputButton">
                                                <option value="">请选择取值</option>
                                            </select>  -->
                                            <input type="text" class="Logic-form-value inputButton" value="${obj[1]}">
                                            <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                                        </li>`
                                    $('.logicLi').eq(i).find(".Logic-form-field").find("option[value='"+obj[0]+"']").attr("selected",true);
                                }
                                if((algorithmfun[i].indexOf('<') !=-1) && (algorithmfun[i].indexOf('<=') == -1)){
                                     obj = algorithmfun[i].split("<")
                                    str+=` <li class="logicLi">
                                                <select name="" class="Logic-form-field inputButton">
                                                    <option value="">${obj[0]}</option>
                                                </select>
                                                <select name="" class="Logic-form-label inputButton">
                                                    <option value="">与</option>
                                                    <option value="">或</option>
                                                    <option value="">非</option>
                                                    <option value="" selected>&lt;</option>
                                                    <option value="">&lt;=</option>
                                                    <option value="">&gt;</option>
                                                    <option value="">&gt;=</option>
                                                    <option value="">=</option>
                                                </select>
                                                <!-- <select name="" class="Logic-form-value inputButton">
                                                    <option value="">请选择取值</option>
                                                </select>  -->
                                                <input type="text" class="Logic-form-value inputButton" value="${obj[1]}">
                                                <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                                            </li>`
                                    $('.logicLi').eq(i).find(".Logic-form-field").find("option[value='"+obj[0]+"']").attr("selected",true);
                                }
                                if((algorithmfun[i].indexOf('<=') !=-1) && (algorithmfun[i].indexOf('<') !=-1)  && (algorithmfun[i].indexOf('=') !=-1)){
                                     obj = algorithmfun[i].split("<=")
                                    str+=` <li class="logicLi">
                                                <select name="" class="Logic-form-field inputButton">
                                                    <option value="">${obj[0]}</option>
                                                </select>
                                                <select name="" class="Logic-form-label inputButton">
                                                    <option value="">与</option>
                                                    <option value="">或</option>
                                                    <option value="">非</option>
                                                    <option value="">&lt;</option>
                                                    <option value="" selected>&lt;=</option>
                                                    <option value="">&gt;</option>
                                                    <option value="">&gt;=</option>
                                                    <option value="">=</option>
                                                </select>
                                                <!-- <select name="" class="Logic-form-value inputButton">
                                                    <option value="">请选择取值</option>
                                                </select>  -->
                                                <input type="text" class="Logic-form-value inputButton" value="${obj[1]}">
                                                <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                                            </li>`
                                    $('.logicLi').eq(i).find(".Logic-form-field").find("option[value='"+obj[0]+"']").attr("selected",true);
                                }
                                if((algorithmfun[i].indexOf('>') !=-1) && (algorithmfun[i].indexOf('>=') == -1)){
                                     obj = algorithmfun[i].split(">")
                                    str+=` <li class="logicLi">
                                            <select name="" class="Logic-form-field inputButton">
                                                <option value="">${obj[0]}</option>
                                            </select>
                                            <select name="" class="Logic-form-label inputButton">
                                                <option value="">与</option>
                                                <option value="">或</option>
                                                <option value="">非</option>
                                                <option value="">&lt;</option>
                                                <option value="">&lt;=</option>
                                                <option value="" selected>&gt;</option>
                                                <option value="">  &gt;=</option>
                                                <option value="">=</option>
                                            </select>
                                            <!-- <select name="" class="Logic-form-value inputButton">
                                                <option value="">请选择取值</option>
                                            </select>  -->
                                            <input type="text" class="Logic-form-value inputButton" value="${obj[1]}">
                                            <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                                        </li>`
                                    $('.logicLi').eq(i).find(".Logic-form-field").find("option[value='"+obj[0]+"']").attr("selected",true);
                                }
                                if((algorithmfun[i].indexOf('=') !=-1) && (algorithmfun[i].indexOf('>') !=-1) && (algorithmfun[i].indexOf('>=') !=-1)){
                                     obj = algorithmfun[i].split(">=")
                                    str+=` <li class="logicLi">
                                                <select name="" class="Logic-form-field inputButton">
                                                    <option value="">${obj[0]}</option>
                                                </select>
                                                <select name="" class="Logic-form-label inputButton">
                                                    <option value="">与</option>
                                                    <option value="">或</option>
                                                    <option value="">非</option>
                                                    <option value="">&lt;</option>
                                                    <option value="">&lt;=</option>
                                                    <option value="">&gt;</option>
                                                    <option value="" selected>&gt;=</option>
                                                    <option value="">=</option>
                                                </select>
                                                <!-- <select name="" class="Logic-form-value inputButton">
                                                    <option value="">请选择取值</option>
                                                </select>  -->
                                                <input type="text" class="Logic-form-value inputButton" value="${obj[1]}">
                                                <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                                            </li>`
                                    $('.logicLi').eq(i).find(".Logic-form-field").find("option[value='"+obj[0]+"']").attr("selected",true);
                                }
                                if((algorithmfun[i].indexOf('=') !=-1) && (algorithmfun[i].indexOf('>') ==-1) && (algorithmfun[i].indexOf('<') == -1)){
                                     obj = algorithmfun[i].split("=")
                                    str+=` <li class="logicLi">
                                            <select name="" class="Logic-form-field inputButton">
                                                <option value="">${obj[0]}</option>
                                            </select>
                                            <select name="" class="Logic-form-label inputButton">
                                                <option value="">与</option>
                                                <option value="">或</option>
                                                <option value="">非</option>
                                                <option value="">&lt;</option>
                                                <option value="">&lt;=</option>
                                                <option value="">&gt;</option>
                                                <option value="">&gt;=</option>
                                                <option value="" selected>=</option>
                                            </select>
                                            <!-- <select name="" class="Logic-form-value inputButton">
                                                <option value="">请选择取值</option>
                                            </select>  -->
                                            <input type="text" class="Logic-form-value inputButton" value="${obj[1]}">
                                            <button class="removeLogic" type="button" onclick="removeLogic(event)">删除</button>
                                        </li>`
                                    $('.logicLi').eq(i).find(".Logic-form-field").find("option[value='"+obj[0]+"']").attr("selected",true);
                                }


                            }
                            $('.logicUl').html(str)
                            $('.Logic').fadeToggle(500)
                        }
                    })
                }
            }
        })
    }
    //逻辑运算新增按钮
    function addLogic(){
        $(".logicUl").append($(".logicLi:first").clone());
    }

     function closeActionDiv() {
         $("#actionDiv").hide()
         $("#actionOutDiv").hide()
     }
     function closeactionSelectDiv() {
         $("#actionSelectDiv").hide()
     }
     function showRk() {
         $("#rkDiv").show()
     }
     function closeBz() {
        $("#rkDiv").hide()
     }
     function saveBzMsg() {
         let val = $('#bzMsg').val();
         $("#rkDiv").hide();
         $("#ruleDes").attr("data",val)
     }
     function closeDeleteZdDiv() {
         $('#deleteZdDiv').hide()
     }
     function deleteZdYes() {
        $.ajax({
            url:urlConfig.host + "/operatorMaintenance/delAlgorithmById",
            data:{algthId:$("#deleteZdButton").attr("deleteId")} ,
            type:"get",
            success(data) {
                if(data.status == 1){
                    $('.noticeList').append(`<li>${parent.getTime()}【算法】 删除成功！</li>`)
                    parent.toastr.success('【算法】 删除成功！')
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                    $('#deleteZdDiv').hide()
                    freshClick("sfWinTree")
                    freshClick("sfTree")
                }
                if(data.status == 2){
                    $('.noticeList').append(`<li>${parent.getTime()} ${data.msg}</li>`)
                    parent.toastr.info(`${data.msg}`)
                    $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
                }
            }
        })
     }
    $('#flex_tools span').click((e)=>{
        $('#flex_tools span').removeClass("liactive");
        $("#groupDiv").hide();
        $("#dicDiv").hide()
        $("#editDic").hide()
        $("#gsFrame").hide()
        $("#groupEditDiv").hide()
        $("#dataModulePage").hide()
        $("#lkrFrame").hide()
        $("#gzDiv").hide()
        $("#fileupload").hide()
        $("#groupTreeDiv").hide()
        $("#searchName").val("");
        var activeName;
        if(e.target.localName == "i"){
            $(e.target).parent().addClass("liactive")
            activeName = $(e.target).parent().text()
        } else {
            $(e.target).addClass("liactive")
            activeName = $(e.target).text()
        }
        if(activeName == "模型库"){
            $(".activeTypeName").text("模型管理")
            $(".activeGroupName").text("模型分组维护")
            
        }
        if(activeName == "算法库"){
            $(".activeTypeName").text("算法管理")
            $(".activeGroupName").text("算法分组维护")
           
        }
        if(activeName == "规则库"){
            $(".activeTypeName").text("规则管理")
            $(".activeGroupName").text("规则分组维护")
        }
        $('#algorithmPage .left-list-tilte').removeClass("divactive")
        if($(".mouldFoot div").css('display') == "none"){
            $(".mouldFoot div").css('display',"flex")
        }
    })
    $('body').on('click','#modelPageDiv .left-list-tilte',(e) => {
        $('#modelPageDiv .left-list-tilte').removeClass("divactive")
        $(e.target).addClass("divactive")
    })
    $('body').on('click','#algorithmPage .left-list-tilte',(e) => {
        $('#algorithmPage .left-list-tilte').removeClass("divactive")
        $(e.target).addClass("divactive")
    })
    $('body').on('click','#ruleListRight .left-list-tilte',(e) => {
        if(window.canvasNowId == "canvas0" && !window.isRuleNow){
            return false
        }
        if (window.frames[canvasNowId] && window.frames[canvasNowId].contentWindow.canvasNowId != "canvas0"  && !window.frames[canvasNowId].contentWindow.isRuleNow) {
            return false
        }
        $('#ruleListRight .left-list-tilte').removeClass("divactive")
        $(e.target).addClass("divactive")
    })
    //获取规则详情
    function getGzList() {
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type:3},
            success(data) {
                var treeData=[]
                data.map(s=>{
                    treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":s.grouptype})
                })
                $.fn.zTree.init($("#gzWinTree"),setting, treeData);
            }
        })
    }
    //规则右侧列表
    function ruleGroupShow() {
        $("#modelPageDiv").hide();
        $("#ruleMde").show();
        $("#algorithmPage").hide();
        $("#ruleListRight").empty()
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type:3},
            success(data) {
                var treeData=[];
                gzDataAll={};
                data.map(s=>{
                    treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":s.grouptype,"right":s.grouptype})
                    $.ajax({
                        url: urlConfig.host + '/algorithmRule/getAllAlgorithmRule',
                        type:"get",
                        data: {groupName:s.groupname},
                        success(data) {
                            if(data.length){
                                var datas = [];
                                data.map(t=>{
                                    datas.push(t.rolename)
                                })
                                gzDataAll[s.groupname] = datas;
                            }
                        }
                    })
                })
                $.fn.zTree.init($("#ruleTree"),setting, treeData);
            }
        })
    }
    function dataModify() {
        if($('#flex_tools .liactive').text() == "模型库"){
            $('#dataModulePage').show()
            $(".mxGruopTable").html(" ")
            getModuleList()         
        }
        if($('#flex_tools .liactive').text() == "算法库"){
            $('#dicDiv').show()
            $(".sfGruopTable").html(" ")
            sfWinList();
            $.ajax({
                url: urlConfig.host + '/module/GetAllModule',
                type: "get",
                success(res){
                    modelSelectList=`<select class="moduleTypeSelect">`;
                    res.map(s=>{
                        modelSelectList+=`<option value="${s.modulename}">${s.modulename}</option>`
                    })
                    modelSelectList+=`</select>`;
                }
            })
        }
        if($('#flex_tools .liactive').text() == "规则库"){
            $('#gzDiv').show()
            $(".gzGruopTable").html(" ")
            getGzList()
        }
    }
    //算法弹窗列表
    function sfWinList() {
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type:2},
            success(data) {
                var treeData=[]
                data.map(s=>{
                    treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":s.grouptype})
                })
                $.fn.zTree.init($("#sfWinTree"),setting, treeData);
            }
        })
    }
    //删除规则
    function deleteGz(s) {
        window.bigData.delRuleId = s;
        $('#lkrRule').fadeToggle(500)
    }
    $(".closeGzDiv").click(()=>{
        $("#gzDiv").hide()
    })
    function exportGz(s) {
        location.href= urlConfig.host+'/algorithmRule/saveAlgorithmRule2File?id=' + s
    }
    function uploadShow() {
        $("#fileupload").show();
        $('#fileupload input').val("")
    }
    function gruopEdit() {
        var type;
        if($('#flex_tools .liactive').text() == "模型库"){
            type=1
        }
        if($('#flex_tools .liactive').text() == "算法库"){
            type=2
        }
        if($('#flex_tools .liactive').text() == "规则库"){
            type=3
        }
        $("#groupDiv").show();
        $("#groupInputName").attr("types",type)
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type :type},
            success(data) {
                if(data.length){
                    var treeData=[]
                    data.map(s=>{
                        treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":"end"})
                    })
                    $.fn.zTree.init($("#groupDivTree"),setting, treeData);
                }
            }
        })
    }
    $(".closeGroupEditDiv").click(()=>{
        $("#groupEditDiv").hide()
    })
    $(".cancelGroup").click(()=>{
        $("#groupEditDiv").hide()
    })
    $("#addGroup").click(()=>{
        $("#groupEditDiv").show();
        $(".groupTitle").text("新增分组")
        $("#groupInputName").attr("modifyId","")
        $("#groupInputName").val("");
        $("#parentGroup").attr("parentid","");
        $("#parentGroup").val("");
        var type = $("#groupInputName").attr("types");
    })

    $("#addGroupYes").click(()=>{
        if($("#groupInputName").val() == ""){
            $('.noticeList').append(`<li>${parent.getTime()}【规则】分组名称不能为空！ </li>`)
            parent.toastr.info(`【规则】分组名称不能为空！` )
            $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
            return false;
        }
        if($("#groupInputName").val() == $("#parentGroup").val()){
            $('.noticeList').append(`<li>${parent.getTime()}【规则】父分组名称和分组名称不能相同！ </li>`)
            parent.toastr.info(`【规则】父分组名称和分组名称不能相同！！` )
            $("#flex_props1_home").scrollTop($("#flex_props1_home")[0].scrollHeight);
            return false;
        }
        var tableGroupdata = {
            "groupname": $("#groupInputName").val(),
            "grouptype":Number($("#groupInputName").attr("types")),
            "id": 0,
            "parentid": $("#parentGroup").attr("parentid") || 0
        }
        if($(".groupTitle").text() == "新增分组"){
            $.ajax({
                url: urlConfig.host + '/group/saveTableGroupMessage',
                type:"POST",
                data:JSON.stringify(tableGroupdata),
                contentType:"application/json",
                success(data) {
                    if(data == "分组名称重复"){
                        parent.$('.noticeList').append(`<li>${parent.getTime()} ${data} </li>`)
                        parent.toastr.info(`${data}` )
                        parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                    } else {
                        parent.$('.noticeList').append(`<li>${parent.getTime()} ${data} </li>`)
                        parent.toastr.info(`${data}` )
                        parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                        $.ajax({
                            url: urlConfig.host + '/group/findAllGroupMessagesByType',
                            type:"get",
                            data: {type :$("#groupInputName").attr("types")},
                            success(data) {
                                $("#groupEditDiv").hide();
                                var types = $("#groupInputName").attr("types");
                                var treeData=[]
                                data.map(s=>{
                                    treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":"end"})
                                })
                                $.fn.zTree.init($("#groupDivTree"),setting, treeData);
                                if($("#groupInputName").attr("types") == 1){
                                    dataModlue()
                                } else if($("#groupInputName").attr("types") == 2){
                                    dictionary()
                                } else if($("#groupInputName").attr("types") == 3){
                                    ruleGroupShow()
                                }
                            }
                        })
                    }
                },
                error(data){
                    parent.$('.noticeList').append(`<li>${parent.getTime()}${data} </li>`)
                    parent.toastr.info(`${data}` )
                    parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                }
            })
        } else {
            tableGroupdata.id = $("#groupInputName").attr("modifyId")
            $.ajax({
                url: urlConfig.host + '/group/updtaTableGroupMessage',
                type:"POST",
                data:JSON.stringify(tableGroupdata),
                dataType: "json",
                contentType:"application/json",
                success(data) {
                    if(data){
                        parent.$('.noticeList').append(`<li>${parent.getTime()} 修改成功！ </li>`)
                        parent.toastr.success(`修改成功！` )
                        parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                        parent.$("#groupEditDiv").hide();
                        $.ajax({
                            url: urlConfig.host + '/group/findAllGroupMessagesByType',
                            type:"get",
                            data: {type :$("#groupInputName").attr("types")},
                            success(data) {
                                $("#groupEditDiv").hide()
                                var typess = $("#groupInputName").attr("types");
                                if(data.length){
                                    var treeData=[]
                                    data.map(s=>{
                                        treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":"end"})
                                    })
                                    $.fn.zTree.init($("#groupDivTree"),setting, treeData);
                                }
                            }
                        })
                        if($("#groupInputName").attr("types") == 1){
                            dataModlue()
                        } else if($("#groupInputName").attr("types") == 2){
                            dictionary()
                        } else if($("#groupInputName").attr("types") == 3){
                            ruleGroupShow()
                        }
                    }
                }
            })
        }
    })
    function modifyGroupShow(td,s,pid) {
        if(pid == 0){
            $("#parentGroup").val("")
        } else {
            $.ajax({
                url: urlConfig.host + '/group/findAllGroupMessagesByType',
                type:"get",
                data: {type:$("#groupInputName").attr("types")},
                success(data) {
                    data.map(s=>{
                        if(s.id == pid){
                            $("#parentGroup").val(s.groupname)
                        }
                    })
                }
            })
        }
        parent.$("#parentGroup").attr("parentid",pid)
        parent.$("#groupEditDiv").show()
        parent.$(".groupTitle").text("修改分组")
        parent.$("#groupInputName").attr("modifyId",s)
        parent.$("#groupInputName").val(td.parent().prev().text())
    }
    $(".groupDivClose").click(()=>{
        $("#groupDiv").hide()
    })
    function ruleDeleteClose() {
        $('#ruleDeleteDiv').hide()
    }
    function deleteGroup(s,type) {
        $("#moduleGroupDelete").show()
        $("#moduleGroupDeleteYes").attr({"deleteId":s,"type":type})
    }
    function ruleDeleteYes() {
        $.ajax({
            url: urlConfig.host + '/group/deleteTableGroupMessage',
            type:"get",
            data: {id :Number($(".deleteRuleButton").attr("deleteId"))},
            success(data) {
                if(data == "删除成功"){
                    $('#ruleDeleteDiv').hide()
                    reloadGroupList();
                    parent.$('.noticeList').append(`<li>${parent.getTime()} 删除成功！ </li>`)
                    parent.toastr.success(`修改成功！` )
                    parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                }
            }
        })
    }
    $('#sfGruopList').on('show.bs.collapse', function (e) {
        accordion(e)
    })
    $('#sfGruopListRight').on('show.bs.collapse', function (e) {
        $.ajax({
            url: urlConfig.host + '/operatorMaintenance/getAllAlgorithm',
            type:"get",
            data: {groupName:$(e.target).attr("groupname")},
            success(data) {
                if(data.length){
                    var div = $(e.target).children();
                    div.empty()
                    data.map((s,index)=>{
                        window.addAlgorithm({
                            name: 'rectangle',
                            icon: 'icon-rectangle',
                            id:s.tableAlgorithm.id,
                            type:"tableAlgorithm",
                            data: {
                                id:s.tableAlgorithm.id,
                                text: s.tableAlgorithm.algorithmname,
                                rect: {
                                    width: 200,
                                    height: 100
                                },
                                parentId:s.tableAlgorithm.id,
                                font: {
                                    fontFamily: 'Arial',
                                    color: 'aqua',
                                    textBaseline: 'top'
                                },
                                data:{
                                    inNum:s.inNum,
                                    outNum:s.outNum,
                                    index:$(e.target).attr('index'),
                                    sid:s.tableAlgorithm.id
                                },
                                children:[],
                                paddingLeft: 10,
                                paddingRight: 10,
                                paddingTop: 10,
                                paddingBottom: 10,
                                borderRadius: 0.1,
                                name: 'rectangle',
                                fillStyle:'rgba(4,44,98,0.58)',
                                strokeStyle: '#4295ec',
                                hideInput:true
                            }
                        })
                    })
                }
            }
        })
    })

    function deleteRuleById(s) {
        window.bigData.delRuleId = s;
        $("#ruleDeleteDiv").show()
    }
    //模型发布
    function publishModule(id,status) {
        $.ajax({
            url: urlConfig.host + '/module/updataStatus',
            type:"get",
            data: {modelId:id,status:status},
            success(data) {
                if(status == "发布"){
                    parent.$('.noticeList').append(`<li>${parent.getTime()} 已发布，发布功能未完善，敬请期待</li>`)
                    parent.toastr.info(`已发布，发布功能未完善，敬请期待！` )
                    parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                } else {
                    parent.$('.noticeList').append(`<li>${parent.getTime()} 取消发布，发布功能未完善，敬请期待！</li>`)
                    parent.toastr.info(`取消发布，发布功能未完善，敬请期待！` )
                    parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                }
                freshClick("modelWinTree")
            }
        })
    }
    //规则发布
    function publishRule(id,status) {
        $.ajax({
            url: urlConfig.host + '/algorithmRule/updataStatus',
            type:"get",
            data: {roleId:id,status:status},
            success(data) {
                if(status == "发布"){
                    parent.$('.noticeList').append(`<li>${parent.getTime()} 已发布，发布功能未完善，敬请期待！</li>`)
                    parent.toastr.info(`已发布，发布功能未完善，敬请期待！` )
                    $("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                } else {
                    parent.$('.noticeList').append(`<li>${parent.getTime()} 取消发布，发布功能未完善，敬请期待！</li>`)
                    parent.toastr.info(`取消发布，发布功能未完善，敬请期待！` )
                    parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                }
                freshClick("gzWinTree")
            }
        })
    }
    //算法发布
    function publishSf(id,status) {
        $.ajax({
            url: urlConfig.host + '/operatorMaintenance/updataStatus',
            type:"get",
            data: {algthId:id,status:status},
            success(data) {
                if(status == "发布"){
                    parent.$('.noticeList').append(`<li>${parent.getTime()} 已发布，发布功能未完善，敬请期待！</li>`)
                    parent.toastr.info(`已发布，发布功能未完善，敬请期待！` )
                    parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                } else {
                    parent.$('.noticeList').append(`<li>${parent.getTime()} 取消发布，发布功能未完善，敬请期待！</li>`)
                    parent.toastr.info(`取消发布，发布功能未完善，敬请期待！` )
                    parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                }
                freshClick("sfWinTree")
            }
        })
    }
    //删除模型分组
    $("#moduleGroupDeleteYes").click(()=>{
        $.ajax({
            url: urlConfig.host + '/group/deleteTableGroupMessage',
            type:"get",
            data: {id :$("#moduleGroupDeleteYes").attr("deleteId")},
            success(res) {
                parent.$('.noticeList').append(`<li>${parent.getTime()} ${res} </li>`)
                parent.toastr.info(`${res} ` )
                parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
                parent.$("#moduleGroupDelete").hide();
                var type = parent.$("#groupInputName").attr("types");
                $.ajax({
                    url: urlConfig.host + '/group/findAllGroupMessagesByType',
                    type:"get",
                    data: {type :type},
                    success(data) {
                        $("#groupEditDiv").hide();
                        if(data.length){
                            var treeData=[]
                            data.map(s=>{
                                treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":"end"})
                            })
                            $.fn.zTree.init($("#groupDivTree"),setting, treeData);
                        }
                        if(type == 1){
                            dataModlue()
                        } else if(type == 2){
                            dictionary()
                        } else if(type == 3){
                            ruleGroupShow()
                        }
                    }
                })
            }
        })
    })
    
    //关闭删除模型分组窗口
    function closeModuleGroupDelete() {
        $("#moduleGroupDelete").hide()
    }
    function downloadRule(s) {
        location.href= urlConfig.host+'/algorithmRule/saveAlgorithmRule2File?id=' + s
    }
    $(".closeEditDic").click(()=>{
        $("#editDic").hide();
    })
    function groupTreeDivShow() {
        $("#groupTreeDiv").show()
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type:$("#groupInputName").attr("types")},
            success(data) {
                var treeData=[]
                data.map(s=>{
                    treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":"win"})
                })
                $.fn.zTree.init($("#groupWinTree"),setting, treeData);
            }
        })
    }
    function closeGroupTreeDiv() {
        $("#groupTreeDiv").hide()
    }
    $(".cancelGroupTree").click(()=>{
        $("#parentGroup").val("");
        $("#modulegroup").val("");
        $("#group").val("");
        $("#groupGs").val("");
        $("#gzGroupName").val("");
        $("#groupTreeDiv").hide();
        $("#parentGroup").attr("parentid",0)
    })
    function groupTreeDataShow(type,type2) {
        $("#groupTreeDiv").show()
        $.ajax({
            url: urlConfig.host + '/group/findAllGroupMessagesByType',
            type:"get",
            data: {type:type},
            success(data) {
                var treeData=[];
                if(type == 1){
                    data.map(s=>{
                        treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":"groupMx"})
                    })
                }
                if(type == 2 && type2 == 1){
                    data.map(s=>{
                        treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":"groupSf"})
                    })
                }
                if(type == 2 && type2 == 2){
                    data.map(s=>{
                        treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":"groupGs"})
                    })
                }
                if(type == 3){
                    data.map(s=>{
                        treeData.push({"name":s.groupname,"id":s.id,"pid":s.parentid,"type":"groupGz"})
                    })
                }
                $.fn.zTree.init($("#groupWinTree"),setting, treeData);
            }
        })
    }
    setTimeout(()=>{
        $(window.top.frames['ueditor_0'].contentWindow.document.body).attr('contenteditable',false)
    },1500)

    function searchData() {
        searchs()
    }
    function keyup_submit(e) {
        var evt = window.event || e;
        if (evt.keyCode == 13){
            searchs()
        }
    }
    
    function searchs() {
        let val = $("#searchName").val();
        if($('.liactive').text() == "模型库"){
            var sfTree = $.fn.zTree.getZTreeObj("moduleTree");
            sfTree.expandAll(true);
            $("#moduleTree a").removeClass("select");
            $("#moduleTree a").removeClass("curSelectedNode");
            $("#moduleListRight").empty()
            if(val == "") return;
            let groupMx = [];
            for(let i in mxDataAll){
                mxDataAll[i].map(s=>{
                    if(s.includes(val)){
                        groupMx.push(i)
                    }
                })
            }
            $("#moduleTree a").each((i,s)=>{
                if($(s).attr("title").includes(val) || groupMx.includes($(s).attr("title"))){
                    $(s).addClass("select")
                }
            })
        } else if($('.liactive').text() == "算法库"){
            var sfTree = $.fn.zTree.getZTreeObj("sfTree");
            sfTree.expandAll(true);
            $("#sfTree a").removeClass("select");
            $("#sfTree a").removeClass("curSelectedNode");
            $("#sfGruopListRight").empty()
            if(val == "") return;
            let groupList = [];
            for(let i in sfDataAll){
                sfDataAll[i].map(s=>{
                    if(s.includes(val)){
                        groupList.push(i)
                    }
                })
            }
            $("#sfTree a").each((i,s)=>{
                if($(s).attr("title").includes(val) || groupList.includes($(s).attr("title"))){
                    $(s).addClass("select")
                }
            })
        } else {
            var sfTree = $.fn.zTree.getZTreeObj("ruleTree");
            sfTree.expandAll(true);
            $("#ruleTree a").removeClass("select");
            $("#ruleTree a").removeClass("curSelectedNode");
            $("#ruleListRight").empty();
            if(val == "") return;
            let groupGz = [];
            for(let i in gzDataAll){
                gzDataAll[i].map(s=>{
                    if(s.includes(val)){
                        groupGz.push(i)
                    }
                })
            }
            $("#ruleTree a").each((i,s)=>{
                if($(s).attr("title").includes(val) || groupGz.includes($(s).attr("title"))){
                    $(s).addClass("select")
                }
            })
        }
    }
    $("#updateGroup").click(()=>{
        if($('#groupDivTree .curSelectedNode').length == 0){
            parent.$('.noticeList').append(`<li>${parent.getTime()} 请先选中分组！</li>`)
            parent.toastr.info(`请先选中分组!` )
            parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
            return
        }
        parent.$("#groupEditDiv").show()
        parent.$(".groupTitle").text("修改分组")
    })
    $("#deleteGroup").click(()=>{
        if($('#groupDivTree .curSelectedNode').length == 0){
            parent.$('.noticeList').append(`<li>${parent.getTime()} 请先选中分组！</li>`)
            parent.toastr.info(`请先选中分组!` )
            parent.$("#flex_props1_home").scrollTop(parent.$("#flex_props1_home")[0].scrollHeight);
            return
        }
        $("#moduleGroupDelete").show()
    })
    $(".closeActionDivLine").click(()=>{
        $("#actionDivLine").hide()
    })

    var dragId = ["dataModulePage","dicDiv","gzDiv","editDic","gsFrame","sureRule","actionDivLine","actionDiv","groupDiv","rkDiv"];
    for(let i=0;i<dragId.length;i++){
        let odiv = document.getElementById(dragId[i])
        odiv.onmousedown = function(ev) {
            var ev = ev || event;
            var disX = ev.clientX - odiv.offsetLeft;
            var disY = ev.clientY - odiv.offsetTop;
            document.onmousemove = function(ev2) {
                var ev2 = ev2 || event;
                var left = ev2.clientX - disX;
                var top = ev2.clientY - disY;
                var w = document.documentElement.clientWidth || document.body.clientWidth;
                var h = document.documentElement.clientHeight || document.body.clientHeight;
                if(left > w - odiv.offsetWidth) {
                    left = w - odiv.offsetWidth
                }
                if(left < 0) {
                    left = 0;
                }
                if(top < 0) {
                    top = 0;
                }
                if(top > h - odiv.offsetHeight) {
                    top = h - odiv.offsetHeight
                }
                odiv.style.left = left + "px";
                odiv.style.top = top + "px"
            }
            document.onmouseup = function(ev2) {
                document.onmousemove = null
            }
        }
    }
    $.ajax({
        url: urlConfig.host + '/loginforweb',
        type: "get",
        success(data){
            console.log(data);
        }
    })
</script>
</body>
</html>
